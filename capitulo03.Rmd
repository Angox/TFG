---
author: "Angel Gonzalez Rizo"
date: "2021"
documentclass: book
forprint: true  # true: imprime a dos caras, false: libro digital
fontsize: 12pt # 10pt,11pt
geometry: margin = 2.5cm 
bibliography: ["bib/library.bib", "bib/paquetes.bib"]
# metodobib -> true: natbib (descomentar: citation_package: natbib) 
#           -> false: pandoc (comentar: citation_package: natbib)
metodobib: true
#natbib: plainnat, abbrvnat, unsrtnat
biblio-style: "plainnat"
#Método 2 (pandoc): descomente una línea de las 2 siguientes en caso de usarlo
csl: methods-in-ecology-and-evolution.csl      # no numera mejor en las citas
#csl: acm-sig-proceedings-long-author-list.csl  # numera peor en las citas
link-citations: yes
output: 
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib  # comentado usa: pandoc-citeproc
    #toc: yes
    fig_caption: yes
    template: latex/templateMemoriaTFE.tex
    includes:
      #before_body: portadas/latex_paginatitulo_modTFE.tex
      #in_header: latex/latex_preambulo.tex
      #after_body: latex/latex_antes_enddoc.tex
editor_options: 
  chunk_output_type: inline
---



```{r include=FALSE}
knitr::opts_chunk$set(
  fig.path = "figurasR/",
  echo = FALSE, warning = FALSE, message = FALSE,
  fig.pos = "H", fig.align = "center", out.width = "95%",
  cache = FALSE
)
```


<!-- \setcounter{chapter}{2} -->
<!-- \setcounter{chapter}{2} escribir 2 para capítulo 3  -->
<!-- \pagenumbering{arabic} -->

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents
<!-- \nocite{*} -->
\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}



# Análisis de los métodos de reparto de escaños

  En este bloque simularemos distintos escenarios para analizarlos según los distintos métodos de reparto de escaños. 

  Los sistemas que analizaremos en este análisis serán, dentro de los métodos de promedio mayor, el método *D´Hondt*, método *Saint-Lague*, método *Saint-Lague modificado*, el método *Huntington-Hill*, el método *Imperiali*, *Danish* y *Adams*. 
Dentro de los métodos de resto mayor analizaremos el método *Droop*, *Hare* e *Imperiali*.


## Procedimiento general



Generaremos datos ficticios de partidos, utilizaremos tres distintas variables, que son el número de partidos, el número de escaños a repartir y la  concentración del voto entre los partidos. De estas tres variables dejaremos dos variables fijas y una tercera que irá variando:

  - La variable *número de partidos* variará entre los 2 posibles partidos hasta los 100 partidos, por ejemplo en países como la India podemos observar que se presentan a las elecciones hasta 2698 partidos, aunque no todos ellos de nivel estatal. En el caso de que la variable quede fija el valor por defecto serán 20 partidos.
  
  
  - La variable *número de escaños* variará entre el reparto de 1 sólo escaño hasta 800 escaños, números similares de escaños a repartir podemos observarlos en Reino Unido o más aún escaños, hasta 2987 en China. En el caso de que la variable quede fija el valor por defecto serán 350 escaños.
  
  
  - La variable *concentración del voto* varía entre una casi máxima igualdad de votos entre partidos, es decir, que casi no hay diferencia de votos entre los distintos partidos, hasta una desigualdad muy marcada de los votos que reciben cada partido. En el caso de que la variable quede fija el valor por defecto será una concentración del voto de nivel medio. Como ejemplo presentamos un gráfico para que sea más comprensivo:
  
```{r}
library(ggplot2)


# Fijar número de partidos
partidos <- paste("Partido_", seq_len(20), sep = "")

# Modificar la concentración del voto
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}
vot_igualdad_media <- vot[[100]]
dis1 <- data.frame("Votos" = 10 * vot[[1]], "Partidos" = seq_len(length(vot[[1]])), "Distribucion" = "Igualdad Alta")

dis2 <- data.frame("Votos" = vot[[100]], "Partidos" = seq_len(length(vot[[100]])), "Distribucion" = "Igualdad Media")

dis3 <- data.frame("Votos" = vot[[300]], "Partidos" = seq_len(length(vot[[300]])), "Distribucion" = "Igualdad Baja")

dis <- rbind(dis1, dis2, dis3)
dis$Distribucion <- as.factor(dis$Distribucion)

# var_dis_sl <- dis1

ggplot(data = dis, mapping = aes(Partidos, Votos, group = Distribucion, color = Distribucion)) +
  geom_point() +
  labs(title = "concentración del voto", caption = "Elaboración propia: Angel González", x = "Partido_i")
```
  
  
## Cálculo de la desproporción

En este bloque los resultados son comparados mediante un índice que calcula la desproporción, que mide cuánto de los votos que obtienen los partidos se traducen a representación en escaños. A continuación presentaremos la función y explicaremos el procedimiento de cálculo:

``` {.R}
desproporción <-
  function(s, v) {  # Variables
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    # Suma de escaños y votos
    s_s <- sum(s)   
    s_v <- sum(v)
    # Dividir escaños y votos entre sus totales
    p_s <- s / s_s
    p_v <- v / s_v
    # Aplicar la fórmula para obtener la desproporción
    o <- (1 / l_s) * sum(abs(p_s - p_v))
    o
  }
```

  - La función depende de dos variables:
    +   *s*: Escaños obtenidos por cada partido.
    +   *v*: Votos obtenidos por cada partido.
    
  - En primer lugar se realiza la suma total de escaños, que se recoge en la variable *s_s* y la suma total de votos, recogida en la variable *s_v*.
  - A continuación para cada partido se dividen los escaños obtenidos entre el total de escaños a repartir, se recoge en la variable *p_s*. El mismo procedimiento para los votos, para cada partido se dividen los votos obtenidos entre el total de votos, recogido en la variable *p_v*.
  - Finalmente para cada partido se restan los resultados *p_s* y *p_v* anteriormente obtenidos, seguidamente nos quedamos con el valor absoluto de los resultados, sumamos todos los valores y los dividimos entre el número de partidos, lo recogemos en la variable *o*.
  

Los valores sobre los que puede variar la función de desproporción parten de 0, que representaría una proporcionalidad perfecta, y cuanto mayor vaya siendo el valor obtenido, peor proporcionalidad presentará. Por lo tanto para un método de reparto deseable lo que se pretende conseguir es presentar el mínimo valor posible, cuanto menor valor de desproporción obtenga mejor método será.




```{r}

library(ggplot2)
library(data.table)
library(ggthemes)

n_partidos <- seq_len(50)[-1]

densidad <- rep(length(n_partidos), 100)

n_escannos <- seq_len(350)
```


## D`Hondt
```{r}

# Variables
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 350
votos <- trunc(vot[[100]])

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 1:n_escannos
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}
```

### D`Hondt variando el número de escaños

```{r}
# D`Hondt Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 800
votos <- vot_igualdad_media

resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
```

<!-- ### D`Hondt Desproporción -->

```{r}
desproporción <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }



dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_dhondt <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según D`Hondt", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, se empieza por repartir un único escaño hasta los 800 posibles escaños.
Observamos que la desproporción en el caso de un escaño es relativamente alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando hasta casi alcanzar la perfección deseada de un valor de la desproporción de 0.  
La diferencia de desproporción entre los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños se va reduciendo, a números altos de escaños a repartir la desproporción tiende a estabilizarse.  
Para este caso apreciamos que a partir de los 50-100 escaños ya la desproporción es muy baja, siendo recomendable la utilización de un número de escaños a partir de los 300.

### D`Hondt variando el número de partidos

```{r}
# D`Hondt Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(100)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100])
}



resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul) # Podriamos no utilizar esto y seguir utilizando listas(mejor)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}



dis[100] <- dis[99]





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_dhondt <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según D`Hondt", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 100 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan de 2 a 12 partidos a las elecciones la desproporción es media, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción alrededor de los 25 partidos que se presentan a las elecciones, a partir de ese punto la curva comienza a decrecer.  
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 2 a 12 ) la desproporción es media, levemente creciente y con una gran variabilidad, a partir de los 12 partidos la variabilidad de un punto al siguiente se estabiliza con una variabilidad decreciente cuantos más partidos entren en la elección.



### D`Hondt variando la concentración del voto

```{r}
# D`Hondt Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 500


# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}










# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}








#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_dhondt <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la concentración del voto", title = "Desproporción según D`Hondt", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.  
Observando el gráfico apreciamos que cuando la concentración del voto es muy baja la desproporción está también en un nivel bajo, cuanto más concentración del voto en pocos partidos comprobamos como la desproporción aumenta, hasta que alcanza un punto en donde alcanza el máximo de desproporción, que sería un punto de concentración de los votos entre partidos media-alta y a partir de ese punto la desproporción va bajando cuanta mayor diferencia de votos se presente entre los partidos.  
Así podemos concluir que el reparto de escaños según la ley D`Hondt es mejor cuanto más concentración de voto tengan unos pocos partidos con respecto a los demás o bien cuando haya poca diferencia de votos entre los partidos.





## Sainte-Lague
```{r}

# Variables
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 5
votos <- trunc(vot[[100]])

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 2 * (1:n_escannos) - 1
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}
```

### Sainte-Lague variando el número de escaños

```{r}
# Sainte-Lague Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 800
votos <- vot_igualdad_media








resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
```

<!-- ### Sainte-Lague Desproporción -->
  
```{r}

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_sl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, se empieza por repartir un único escaño hasta los 800 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando.
La diferencia de desproporción en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños va reduciéndose, a partir de los 50 escaños es aceptable la desproporción aunque sería deseable partir de los 200 escaños.

### Sainte-Lague variando el número de partidos

```{r}
# Sainte-Lague Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(100)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100])
}



resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}



dis[100] <- dis[99]





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_sl <- dis1


ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 100 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 partidos a las elecciones la desproporción empieza siendo alta, queda en un mismo nivel a medida que se presentan más partidos, alcanzando el máximo de desproporción con 25 partidos que se presentan a las elecciones, a partir de ese punto la curva desciende constantemente alcanzando cotas de desproporción muy deseables.
Podemos apreciar en el gráfico que para un número de 2 a 25 partidos que se presentan a las elecciones la desproporción es alta y presenta mucha variabilidad, a partir de los 26 partidos, cuanto mayor número de partidos se presenten en las elecciones menor va a ser variabilidad que encontremos.



### Sainte-Lague variando la concentración del voto

```{r}
# Sainte-Lague Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 500


# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}










# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}








#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_sl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la concentración del voto", title = "Desproporción según Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.
En este método de Sainte-Lague la desproporción es especialmente baja, característica muy deseable, además no se aprecian diferencias de desproporción en casos de poca a alta concentración del voto, la variabilidad que apreciamos en la gráfica es alta pero teniendo en cuenta el rango en que se mueve podemos decir que la variabilidad es baja sea cual sea la concentración del voto.


## Modified Sainte-Lague
```{r}

# Variables
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 5
votos <- trunc(vot[[100]])

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- c(1, (10 * (2:n_escannos) - 5) / 7)
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}
```

### Modified Sainte-Lague variando el número de escaños

```{r}
# Modified Sainte-Lague Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 800
votos <- vot_igualdad_media








resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
```

<!-- ### Modified Sainte-Lague Desproporción -->
  
```{r}

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_msl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Modified Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 800 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando.
La diferencia que encontramos de desproporción entre los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños va reduciéndose, a números altos de escaños a repartir la desproporción tiende a estabilizarse. En este método también empieza a ser aceptable escoger un número de escaños igual o mayor a 50 escaños.

### Modified Sainte-Lague variando el número de partidos

```{r}
# Modified Sainte-Lague Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(100)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100])
}



resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}



dis[100] <- dis[99]





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_msl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Modified Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 100 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan  de 2 a 20 partidos a las elecciones la desproporción es media, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción alrededor de los 28 partidos que se presentan a las elecciones, número del cual la curva comienza a decrecer.
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 2 a 20 ) la varianza es alta, a partir de ese número de partidos la diferencia entre los siguientes puntos va reduciéndose paulatinamente cuanto mayor número de partidos concurran a las elecciones ficticias.



### Modified Sainte-Lague variando la concentración del voto

```{r}
# Modified Sainte-Lague Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 500


# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}










# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}








#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_msl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la concentración del voto", title = "Desproporción según Modified Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.  
Observando el gráfico observamos que la desproporción, tal y como sucedía con el método Sainte-Lague, es muy baja, manteniéndose en una misma franja ya sea la concentración del voto entre los partidos alta o baja.  
Así podemos concluir que el reparto de escaños según la ley Modified Sainte-Lague en este caso presenta unas cualidades muy deseables, tiene un nivel de desproporción muy bajo y no depende significativamente del nivel de la concentración del voto entre los partidos.


## Imperiali
```{r}

# Variables
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 5
votos <- trunc(vot[[100]])

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- ((1:n_escannos) + 1) / 2
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}
```

### Imperiali variando el número de escaños

```{r}
# Imperiali Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 800
votos <- vot_igualdad_media








resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
```

<!-- ### Imperiali Desproporción -->
  
```{r}

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_imp <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Imperiali", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 800 posibles escaños.
La desproporción en el caso de un escaño es muy alta como suele suceder en los métodos anteriormente analizados, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando constantemente.  
En este método Imperiali podemos comprobar como el descenso de la desproporción no es tan acusado como otros métodos anteriormente analizados, empezando a tener una desproporción aceptable a partir de los 500 escaños.  
La diferencia de desproporción en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños va reduciéndose y a números altos de escaños a repartir la desproporción tiende a estabilizarse.  

### Imperiali variando el número de partidos

```{r}
# Imperiali Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(100)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100])
}



resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}



dis[100] <- dis[99]





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_imp <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Imperiali", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 100 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 o 3 partidos a las elecciones la desproporción es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción con 24 partidos que se presentan a las elecciones, a partir de ese punto la curva decrece constantemente.
Entonces, según el modelo Imperiali tendremos una mejor desproporción según se vaya aumentando el número de partidos o bien si se presentan un número muy reducido de partidos.



### Imperiali variando la concentración del voto

```{r}
# Imperiali Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 500


# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}










# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}








#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_imp <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la concentración del voto", title = "Desproporción según Imperiali", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.
Observando el gráfico observamos que cuando la concentración del voto es muy baja la desproporción está en un nivel bajo, cuanto más concentración de voto podemos comprobar como la desproporción aumenta hasta que alcanza un punto en donde alcanza el máximo de desproporción, alrededor de una concentración del voto media y a partir de ese punto la desproporción va bajando constantemente.
El reparto de escaños según la ley Imperiali obtiene su menor desproporción en los escenarios en donde la diferencia de votos entre los partidos sea muy baja, aunque en comparación con los métodos anteriormente analizados su desproporción es significativamente mas alta.


## Huntington-Hill
```{r}

# Variables
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 5
votos <- trunc(vot[[100]])

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  
  
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- sqrt((1:n_escannos) * ((1:n_escannos) - 1))
  G <- sapply(div, function(x) votos / x)
  G[is.na(G)] <- 0
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Fix seats
  if(sum(o)>n_escannos){
    if(n_escannos==1) {G <- cbind("n"=0,votos) }
    cuota <- G[,2][order(G[,2], decreasing = T)][n_escannos]
    W1 <- (G[,2] >= cuota)
    seats <- as.numeric(W1)
    o <- seats
  }
  
  
  
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}
```

### Huntington-Hill variando el número de escaños

```{r}
# Huntington-Hill Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 800
votos <- vot_igualdad_media








resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
```

<!-- ### Huntington-Hill Desproporción -->
  
```{r}

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_hh <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Huntington-Hill", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, se empieza por repartir un único escaño hasta los 800 posibles escaños.
Observamos que la desproporción en el caso de repartir unos pocos escaños es muy alta, desciende rápidamente en los primeros escaños hasta llegar alrededor de los 10 a 20 escaños, en donde se estabiliza temporalmente, a partir de los 20 escaños vuelve a descender rápidamente. Este comportamiento se entiende por el hecho de repartir más escaños que partidos se presentan a las elecciones. A partir de los 50 escaños desciende lentamente y tiende a estabilizarse cuanto mayor número de escaños se reparten. Sería deseable elegir un número de escaños entre los 100 y 200, en donde ya parece que se estabiliza y presenta niveles muy bajos de desproporción.


### Huntington-Hill variando el número de partidos

```{r}
# Huntington-Hill Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(100)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos[[i]] <- trunc(votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100]))
}



resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}



dis[100] <- dis[99]





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_hh <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Huntington-Hill", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 100 partidos que se presentan a una elección ficticia.  
Observamos que cuando se presentan de 2 a 24 partidos a las elecciones la desproporción es bastante baja, va aumentando significativamente a medida que se presentan más partidos, alcanzando el máximo de desproporción con 50 partidos que se presentan a las elecciones, a partir de los 50 partidos la curva cambia drásticamente, baja  la desproporción  y comienza a decrecer. Esto es debido a que se reparten menos escaños que partidos se presentan a las elecciones.
Lo particular de este método respecto a otros métodos es que la menor desproporción se obtiene en el caso de que se presenten a las elecciones pocos partidos o muchos partidos y que en los 50 partidos alcanza el máximo de desproporción.


### Huntington-Hill variando la concentración del voto

```{r}
# Huntington-Hill Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 500


# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}










# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}








#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_hh <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la concentración del voto", title = "Desproporción según Huntington-Hill", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.  
Observando el gráfico observamos que cuando la concentración del voto es muy baja la desproporción está en un nivel bajo, desproporción que se mantiene baja cuando la concentración de los votos es media, y que a partir de una concentración de votos media-alta la desproporción va aumentando cuanto más diferencia de votos entre partidos se presenten.  
Así podemos concluir que el reparto de escaños según la ley Huntington-Hill es mejor cuanto menor concentración de voto tengan los partidos entre ellos o cuando la concentración de voto sea media, presenta un comportamiento diferente respecto a los otros métodos en donde cuanto mayor concentración de votos, menor desproporción. No es un buen método para el caso en que los votos estén concentrados en pocos partidos.


## Adams
```{r}

# Variables
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 5
votos <- trunc(vot[[100]])

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 1:n_escannos - 1
  div[is.na(div)] <- 0
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Fix seats
  if(sum(o)>n_escannos){
    if(n_escannos==1) {G <- cbind("n"=0,votos) }
    cuota <- G[,2][order(G[,2], decreasing = T)][n_escannos]
    W1 <- (G[,2] >= cuota)
    seats <- as.numeric(W1)
    o <- seats
  }
  
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}
```

### Adams variando el número de escaños

```{r}
# Adams Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 800
votos <- vot_igualdad_media








resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
```

<!-- ### Adams Desproporción -->

```{r}

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_ad <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Adams", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, se empieza por repartir un único escaño hasta los 800 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, en este método también observamos una alta desproporción inicial que se mantiene hasta los 50 escaños, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando. Sucede en este caso la misma situación que en el método Huntington-Hill, en donde el comportamiento difiere si se reparten más escaños que partidos se presentan a las elecciones. En nuestro caso sucede en los 20 escaños a repartir porque hay 20 partidos que se presentan a las elecciones.  Este método presenta una desproporción que se reduce algo más lentamente que otros métodos, comenzando a ser aceptable a partir de los 100 escaños aproximadamente.

### Adams variando el número de partidos

```{r}
# Adams Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(100)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100])
}



resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}



dis[100] <- dis[99]





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_ad <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Adams", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 100 partidos que se presentan a una elección ficticia.  
Observamos que cuando se presentan de 2 a 23  partidos a las elecciones la desproporción es baja con una variabilidad alta, como sucedía con el método Huntington-Hill, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción con 50 partidos que se presentan a las elecciones, a partir de los 50 partidos que se presentan a las elecciones sucede que se empiezan a repartir menos escaños que partidos se presentan a las elecciones, debido a ello baja la desproporción y la curva comienza a decrecer.  
En este método Adams obtenemos el mejor resultado cuanto menor número de partidos se presenten a las elecciones o bien cuando se presenten muchos partidos, no siendo aconsejable utilizar este método cuando se presenten entre 25 a 50 partidos a las elecciones.


### Adams variando la concentración del voto

```{r}
# Adams Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 500


# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}










# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}








#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_ad <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la concentración del voto", title = "Desproporción según Adams", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.  
Según el gráfico observamos que cuando la concentración del voto es muy baja, la desproporción también está en un nivel bajo. Cuanto más concentración de voto se encuentren entre los partidos la desproporción va aumentando cada vez más, éste es un método que depende mucho de la concentración del voto.  
Podemos concluir que el reparto de escaños según la ley Adams es mejor cuanto menor concentración de voto tengan los partidos entre ellos, y será peor cuanto mayor concentración de voto se presente.

## Danish
```{r}

# Variables
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 5
votos <- trunc(vot[[100]])

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 3 * (1:n_escannos) - 2
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}
```

### Danish variando el número de escaños

```{r}
# Danish Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 800
votos <- vot_igualdad_media








resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
```

<!-- ### Danish Desproporción -->
  
```{r}

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_dan <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Danish", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 800 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando.
La diferencia de desproporción en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños va reduciéndose, a números altos de escaños a repartir la desproporción tiende a estabilizarse.

### Danish variando el número de partidos

```{r}
# Danish Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(100)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100])
}



resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}



dis[100] <- dis[99]





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_dan <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Danish", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 100 partidos que se presentan a una elección ficticia.  
Observamos que cuando se presentan de 2 a 25 partidos a las elecciones la desproporción es media-alta, alcanza su máximo con 25 partidos, a partir del cual comienza a decrecer.
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 4 a 25 ) la desproporción es medio-alta y estable dentro de un mismo rango, cuanto mayor número de partidos se presentan en las elecciones menor es la desproporción que encontramos.
Según lo visto en el gráfico, en el método Danish obtenemos el mejor resultado cuanto más partidos se presenten a las elecciones.



### Danish variando la concentración del voto

```{r}
# Danish Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 500


# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}










# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}








#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_dan <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la concentración del voto", title = "Desproporción según Danish", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.  
Observando el gráfico observamos que la concentración del voto no depende de la desproporción, que se encuentra en un mismo rango sea la concentración del voto alta o baja.  
El reparto de escaños según la ley Danish presenta unas características muy deseables, el nivel de desproporción es extremadamente bajo y no depende significativamente de la concentración del voto.



## LR Hare


``` {.R}
Para diferenciar entre los métodos de resto mayor y promedio mayor, 
procederemos a añadir el prefijo LR ( Largest Remainder ) 
a los métodos de resto mayor.
```


```{r}

# Variables
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 5
votos <- trunc(vot[[100]])

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- trunc(nv / n_escannos) # Parte entera
  G <- sapply(div, function(x) votos / x)
  o <- as.vector(trunc(G))
  # Fix
  if (sum(o) < n_escannos) {
    resto <- G - o
    repart <- n_escannos - sum(o)
    cuota <- resto[order(resto, decreasing = T)][repart]
    W <- (resto >= cuota) 
    seats <- o + rowSums(W)
    o <- seats
  }

  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}
```

### LR Hare variando el número de escaños

```{r}
# LR Hare Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 800
votos <- vot_igualdad_media



resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
```

<!-- ### LR Hare Desproporción -->
  
```{r}

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_hare <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según LR Hare", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 800 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción desciende rápidamente en comparación con métodos anteriormente analizados, llegando a un nivel aceptable de desproporción entre los 100 a 200 escaños.

### LR Hare variando el número de partidos

```{r}
# LR Hare Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(100)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100])
}



resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}



dis[100] <- dis[99]





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_hare <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según LR Hare", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 100 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan un número bajo de partidos a las elecciones, entre 2 a 25, la desproporción es alta, va disminuyendo a medida que se presentan más partidos, alcanzando el mínimo de desproporción cuantos más partidos se presenten a las elecciones  .
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 2 a 25 ) la dispersión es alta pero decreciente, a partir de los 25 escaños la variabilidad tiende a estabilizarse cuanto mayor número de partidos se presenten en las elecciones.  
Según el método LR Hare obtendremos el mejor resultado en términos de desproporción cuanto más partidos se presenten a las elecciones.



### LR Hare variando la concentración del voto

```{r}
# LR Hare Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 500


# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}










# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}








#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_hare <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la concentración del voto", title = "Desproporción según LR Hare", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.  
Observando el gráfico comprobamos como la concentración del voto no es significativa para el nivel de desproporción, característica deseable. Puede apreciarse una leve tendencia descendiente al aumentar la concentración del voto, lo que podría dar a entender que a concentraciones del voto extremadamente altas, el método LR-Hare alcanzaría el mínimo nivel de desproporción.



## LR Droop
```{r}

# Variables
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 5
votos <- trunc(vot[[100]])

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- trunc(nv / (n_escannos + 1)) # Parte entera
  G <- sapply(div, function(x) votos / x)
  o <- as.vector(trunc(G))
  #Fix
  while(sum(o)<n_escannos){
    resto <- G-o 
    faltan <- n_escannos-sum(o)
    cuota <- resto[order(resto, decreasing = T)][faltan]
    W <- (resto >= cuota)
    seats <- rowSums(W)
    o <- o+seats
    }

  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}
```

### LR Droop variando el número de escaños

```{r}
# LR Droop Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 800
votos <- vot_igualdad_media








resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
```

<!-- ### LR Droop Desproporción -->
  
```{r}

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_Droop <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según LR Droop", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 800 posibles escaños.
La desproporción en el caso de pocos escaños es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando constantemente.  
La diferencia de desproporción entre los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños va reduciéndose, a números altos de escaños a repartir la desproporción tiende a estabilizarse.  
Este método LR-Droop alcanza niveles de desproporción aceptables a partir de los 50 escaños y niveles deseables alrededor de los 200 escaños.

### LR Droop variando el número de partidos

```{r}
# LR Droop Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(100)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100])
}



resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}



dis[100] <- dis[99]





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_Droop <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según LR Droop", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 100 partidos que se presentan a una elección ficticia.
Gran variabilidad en el caso de que se presenten un número bajo de partidos, hasta los 25 partidos, en esta zona la desproporción es alta y se mueve en un mismo nivel. A partir de los 25 partidos que se presentan a las elecciones la variabilidad cambia totalmente respecto a la zona anterior y se vuelve estable, con un descenso paulatino y no muy acusado. Se empieza a tener desproporciones bajas a partir de los 50 partidos.  
Según lo visto, en el método LR-Droop obtendremos el mejor resultado cuanto más partidos se presenten a las elecciones.



### LR Droop variando la concentración del voto

```{r}
# LR Droop Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 500


# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}










# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}








#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_Droop <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la concentración del voto", title = "Desproporción según LR Droop", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.  
Observando el gráfico observamos que ya sea la concentración del voto muy baja, media o muy alta,la desproporción se encuentra en un mismo nivel, nivel en términos de desproporción muy bajos, cercanos al 0. Dentro del rango entre que se encuentra la desproporción la variabilidad es alta para cualquier nivel de concentración.  
En este puede decirse que el método Droop posee una buena cualidad, puesto que su proporcionalidad no depende de la concentración del voto.


## LR Imperiali
```{r}

# Variables
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 5
votos <- trunc(vot[[100]])

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- trunc(nv / (n_escannos + 2)) # Parte entera
  G <- sapply(div, function(x) votos / x)
  o <- trunc(G)
  #Fix
  while(sum(o)<n_escannos){
    resto <- G-o 
    faltan <- n_escannos-sum(o)
    cuota <- resto[order(resto, decreasing = T)][faltan]
    W <- (resto >= cuota)
    seats <- rowSums(W)
    o <- o+seats
    }

  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

```

### LR Imperiali variando el número de escaños

```{r}
# LR imperialilr Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 800
votos <- vot_igualdad_media








resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
```

<!-- ### LR imperialilr Desproporción -->
  
```{r}

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_imperialilr <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según LR imperiali", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 800 posibles escaños.
No hay diferencia en el comportamiento respecto a los otros métodos de restos mayores.
La desproporción en el caso que se repartan pocos escaños es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción baja rápidamente hasta alcanzar niveles aceptables cuando se reparten 100 escaños y niveles deseables a partir de los 200 escaños.

### LR Imperiali variando el número de partidos

```{r}
# LR imperialilr Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(100)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100])
}



resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}



dis[100] <- dis[99]





dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_imperialilr <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según LR imperiali", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 100 partidos que se presentan a una elección ficticia.  
Observamos que cuando se presentan de 2 a 25 partidos a las elecciones la desproporción se encuentra en los máximos, disminuye a medida que se presentan más partidos, alcanzando el mínimo de desproporción cuantos más partidos se presenten a las elecciones.  
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 2 a 25 ) la variabilidad es alta pero decreciente, a partir de los 25 partidos la variabilidad se estabiliza.  
Concluimos que según el método LR-Imperiali obtenemos el mejor resultado cuanto más partidos se presenten a las elecciones, empieza a presentar una desproporción menor alrededor de los 50 partidos.



### LR Lmperiali variando la concentración del voto

```{r}
# LR imperialilr Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(20), sep = "")
n_escannos <- 500


# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}










# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}








#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_imperialilr <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la concentración del voto", title = "Desproporción según LR imperiali", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.  
Observando el gráfico observamos que la desproporción está en un mismo nivel ya se encuentre con una concentración de voto alta o baja. El nivel de desproporción es muy bajo, por lo tanto muy deseable, con valores muy cercanos a 0. Es un método que también presenta una buena cualidad, puesto que su proporcionalidad es prácticamente independientemente de la concentración del voto.


## Comparaciones entre métodos

  En este apartado procederemos a agrupar todos los resultados de los métodos utilizados anteriormente. El objetivo es ser capaces de comparar en un mismo gráfico todos los métodos y sacar conclusiones. Se agruparán los datos de los tres escenarios posibles, variando el número de escaños, el número de partidos que se presentan a las elecciones o bien la concentración de los votos entre los partidos.
  
Se recomiendan visitar los gráficos interactivos en la siguiente dirección: <https://rpubs.com/angox/cap3int>

### Variando el número de escaños
```{r}
var_esc_dhondt$Metodo <- "D`Hondt"
var_esc_sl$Metodo <- "Sainte-Lague"
var_esc_msl$Metodo <- "Modified Sainte-Lague"
var_esc_imp$Metodo <- "Imperiali"
var_esc_hh$Metodo <- "Huntington-Hill"
var_esc_ad$Metodo <- "Adams"
var_esc_dan$Metodo <- "Danish"
var_esc_hare$Metodo <- "LR-Hare"
var_esc_Droop$Metodo <- "LR-Droop"
var_esc_imperialilr$Metodo <- "LR-Imperiali"

var_esc <- rbind(var_esc_dhondt, var_esc_sl, var_esc_msl, var_esc_imp, var_esc_hh, var_esc_ad, var_esc_dan, var_esc_hare, var_esc_Droop, var_esc_imperialilr)

# ggplot(data = var_esc, mapping = aes(Escannos, Desproporción)) +
#   # geom_point(data = var_esc, mapping = aes(fill = "Metodo"), show.legend = F) +
#   geom_point() +
#   facet_grid(cols = vars(Metodo)) +
#   scale_fill_gradient(low = "red", high = "yellow") +
#   labs(subtitle = "Variando la concentración del voto", title = "Desproporción según Danish", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")

library(ggrepel)
ggplot(data = var_esc, mapping = aes(Escannos, Desproporción)) +
  geom_line(aes(colour = factor(Metodo)), size = 1) +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción ", caption = "Elaboración propia: Angel González", x = "Número de Escaños") +
  # labs(title = "Variando la concentración del voto", subtitle = "Desproporción", caption = "Elaboración propia: Angel González", x = "Número de Escaños")+
  guides(color = guide_legend(title = "Método")) +
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
  )
# +geom_label_repel(data = var_esc[var_esc$Escannos == 100,],
#                    aes(label = factor(Metodo)),
#                    max.overlaps = 100,
#                    nudge_x = .7,
#                    na.rm = TRUE)
```
En el presente gráfico comparamos en un mismo lugar los métodos anteriormente analizados individualmente.  
En esta comparación podemos observar que para todos los métodos a pocos escaños a repartir la desproporción es muy alta y no hay casi diferencia entre métodos, la desproporción baja cuanto mayor número de escaños a repartir, a números muy altos de escaños la desproporción está muy cercana al 0 y casi no hay diferencia de desproporción entre métodos.  
El peor métodos en este caso es el Imperiali, que presenta una curva con un descenso mucho más lento que los demás métodos. Todos los demás métodos presentan un comportamiento similar.


```{r}
# var_esc_dhondt$Metodo <- "D`Hondt"
# var_esc_sl$Metodo <- "Sainte-Lague"
# var_esc_msl$Metodo <- "Modified Sainte-Lague"
# var_esc_imp$Metodo <- "Imperiali"
# var_esc_hh$Metodo <- "Huntington-Hill"
# var_esc_ad$Metodo <- "Adams"
# var_esc_dan$Metodo <- "Danish"
# var_esc_hare$Metodo <- "LR-Hare"
# var_esc_Droop$Metodo <- "LR-Droop"
#
# var_esc <- rbind(var_esc_dhondt, var_esc_sl, var_esc_msl, var_esc_imp, var_esc_hh, var_esc_ad, var_esc_dan,var_esc_hare,var_esc_Droop)

# ggplot(data = var_esc, mapping = aes(Escannos, Desproporción)) +
#   # geom_point(data = var_esc, mapping = aes(fill = "Metodo"), show.legend = F) +
#   geom_point() +
#   facet_grid(cols = vars(Metodo)) +
#   scale_fill_gradient(low = "red", high = "yellow") +
#   labs(subtitle = "Variando la concentración del voto", title = "Desproporción según Danish", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")

ggplot(data = var_esc[var_esc$Escannos > 300 & var_esc$Escannos < 400, ], mapping = aes(Escannos, Desproporción)) +
  geom_line(aes(colour = factor(Metodo))) +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción ", caption = "Elaboración propia: Angel González", x = "Número de Escaños") +
  guides(color = guide_legend(title = "Método")) +
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(3, 3, 3, 3)
  )
```

En este gráfico nos centramos en la desproporción para un número de escaños a repartir de entre 300 y 400 diputados, actualmente en España se reparten 350 diputados.
El peor método entre los presentados es el método Imperiali, con una diferencia significativa respecto a los demás métodos.
Podemos agrupar los métodos en dos grupos,un grupo que sería el de una desproporción alta, en el que se encontrarían los métodos de Imperiali, Adams y D´Hondt.
Un segundo grupo que sería el que presentaría una desproporción baja o media, con los restantes métodos.

Actualmente en España se reparten 350 escaños y se utiliza el método D´Hondt, según los datos obtenidos podemos concluir que no es el mejor método que se puede utilizar, es un método que está en el grupo de desproporción alta, e incluso no es siempre el mejor método dentro de ese subgrupo, sería interesante según lo observado en la gráfica plantearse un cambio de método a otro mejor, al menos, a alguno dentro del subgrupo de desproporción baja, preferentemente el mejor método que podríamos utilizar dentro de los métodos de promedio mayor, que sería el método de Sainte-Lague sin modificar.
Hay que tener en cuenta también que debido a que en España no se reparten los 350 diputados por circunscripción única las conclusiones cambiarían levemente. En el caso de que se repartan de 1 a 20 escaños el método D´Hont sigue sin ser uno de los mejores métodos, pero su desproporción es muy similar a los demás métodos por lo que hace al método D´Hont aceptable cuando se trata de repartir pocos escaños.

### Variando el número de partidos
```{r}
var_par_dhondt$Metodo <- "D`Hondt"
var_par_sl$Metodo <- "Sainte-Lague"
var_par_msl$Metodo <- "Modified Sainte-Lague"
var_par_imp$Metodo <- "Imperiali"
var_par_hh$Metodo <- "Huntington-Hill"
var_par_ad$Metodo <- "Adams"
var_par_dan$Metodo <- "Danish"
var_par_hare$Metodo <- "LR-Hare"
var_par_Droop$Metodo <- "LR-Droop"
var_par_imperialilr$Metodo <- "LR-Imperiali"

var_par <- rbind(var_par_dhondt, var_par_sl, var_par_msl, var_par_imp, var_par_hh, var_par_ad, var_par_dan, var_par_hare, var_par_Droop, var_par_imperialilr)


ggplot(data = var_par, mapping = aes(Escannos, Desproporción)) +
  geom_point(aes(colour = factor(Metodo))) +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción", caption = "Elaboración propia: Angel González", x = "Número de partidos") +
  guides(color = guide_legend(title = "Método")) +
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
  )
```

En el presente gráfico comparamos la desproporción variando el número de partidos en un mismo lugar con los métodos anteriormente analizados individualmente.

Observamos que para un número de partidos bajo hasta los 25 partidos que se presentan a unas elecciones la desproporción es muy variable, a partir de los 25 partidos se estabiliza y podemos sacar algunas conclusiones, en primer lugar el peor método claramente en este caso es el método Imperiali y Huntington-Hill, mientras que los demás métodos son similares en su desproporción, donde la menor desproporción la podemos encontrar entre los métodos Sainte-Lague y LR-Hare. A continuación nos centraremos en la desproporción cuando se presentan pocos partidos para analizarlo más detenidamente.


```{r}
# var_par_dhondt$Metodo <- "D`Hondt"
# var_par_sl$Metodo <- "Sainte-Lague"
# var_par_msl$Metodo <- "Modified Sainte-Lague"
# var_par_imp$Metodo <- "Imperiali"
# var_par_hh$Metodo <- "Huntington-Hill"
# var_par_ad$Metodo <- "Adams"
# var_par_dan$Metodo <- "Danish"
# var_par_hare$Metodo <- "LR-Hare"
#
# var_par <- rbind(var_par_dhondt, var_par_sl, var_par_msl, var_par_imp, var_par_hh, var_par_ad, var_par_dan,var_par_hare)


ggplot(data = var_par[var_par$Escannos < 50, ], mapping = aes(Escannos, Desproporción)) +
  geom_point(aes(colour = factor(Metodo))) +
  geom_line(aes(colour = factor(Metodo)), size = 1) +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción", caption = "Elaboración propia: Angel González", x = "Número de partidos") +
  guides(color = guide_legend(title = "Método")) +
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
  ) +
  geom_label_repel(
    data = var_par[var_par$Escannos == 34, ],
    aes(label = factor(Metodo)),
    max.overlaps = 100,
    nudge_x = .9,
    na.rm = TRUE,
    force_pull = 0
  )
```

En este gráfico nos centramos en la desproporción para un número de partidos entre 2 y 50 partidos.

Observamos que hasta los 20 partidos que se presentan a las elecciones la desproporción es muy variable entre ellos, a partir de los 20 partidos que se presentan en las elecciones podemos extraer algunas conclusiones, se ven dos grupos diferenciados, un grupo en donde la desproporción es estable e incluso decreciente  y otro grupo en el que la desproporción va aumentando, que son los métodos de Adams y Huntington-Hill.  
En España se utiliza el método D´Hondt, según los datos obtenidos podemos concluir que el método d´Hondt no es el mejor método entre los analizados, se encontraría en un nivel medio-alto entre los métodos posibles, es decir, sería deseable para obtener una mayor proporcionalidad que se cambiase el método de reparto a otro mejor, en este caso observamos que el mejor método dentro del grupo de promedios mayores es el Saint-Lague y dentro del grupo de resto mayor el mejor parado es el método LR-Hare.

### Variando la concentración del voto
```{r}
var_dis_dhondt$Metodo <- "D`Hondt"
var_dis_sl$Metodo <- "Sainte-Lague"
var_dis_msl$Metodo <- "Modified Sainte-Lague"
var_dis_imp$Metodo <- "Imperiali"
var_dis_hh$Metodo <- "Huntington-Hill"
var_dis_ad$Metodo <- "Adams"
var_dis_dan$Metodo <- "Danish"
var_dis_hare$Metodo <- "LR-Hare"
var_dis_Droop$Metodo <- "LR-Droop"
var_dis_imperialilr$Metodo <- "LR-Imperiali"

var_dis <- rbind(var_dis_dhondt, var_dis_sl, var_dis_msl, var_dis_imp, var_dis_hh, var_dis_ad, var_dis_dan, var_dis_hare, var_dis_Droop, var_dis_imperialilr)


ggplot(data = var_dis, mapping = aes(Escannos, Desproporción)) +
  geom_point(aes(colour = factor(Metodo))) +
  labs(subtitle = "Variando la distribucion de los votos", title = "Desproporción", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)") +
  guides(color = guide_legend(title = "Método")) +
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
  )

```

En el presente gráfico comparamos la concentración del voto en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande. Todo ello en un mismo lugar con los métodos anteriormente analizados individualmente.  

Observamos que hay dos grupos diferenciados, uno de ellos en los que la desproporción es baja para una menor concentración de votos entre los partidos y que a medida que la concentración aumenta también va aumentando la desproporción, donde se encuentran los métodos de Adams y Huntington-Hill, también se comporta así el método Imperiali hasta una concentración de votos media. El otro grupo se caracteriza por ya sea la concentración del voto muy baja o muy alta, la desproporción está en un nivel bajo y no varía significativamente.

```{r}
# var_dis_dhondt$Metodo <- "D`Hondt"
# var_dis_sl$Metodo <- "Sainte-Lague"
# var_dis_msl$Metodo <- "Modified Sainte-Lague"
# var_dis_imp$Metodo <- "Imperiali"
# var_dis_hh$Metodo <- "Huntington-Hill"
# var_dis_ad$Metodo <- "Adams"
# var_dis_dan$Metodo <- "Danish"
# var_dis_hare$Metodo <- "LR-Hare"
#
# var_dis <- rbind(var_dis_dhondt, var_dis_sl, var_dis_msl, var_dis_imp, var_dis_hh, var_dis_ad, var_dis_dan,var_dis_hare)

var_dis$Metodo <- as.factor(var_dis$Metodo)
ggplot(data = var_dis[var_dis$Escannos > 400, ], mapping = aes(Escannos, Desproporción)) +
  geom_point(aes(colour = Metodo, shape = Metodo)) +
  scale_shape_manual(values = c(1:10)) +
  # geom_line(aes(colour = factor(Metodo)), size = 1)+
  labs(subtitle = "Variando la distribucion de los votos", title = "Desproporción", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)") +
  # guides(color = guide_legend(title = "Método")) +
  # guides(fill = FALSE)  +
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
  )
```


En este gráfico nos centramos en los casos en que hay mayor concentración de votos de unos pocos partidos, lo que suele suceder habitualmente.  
Vemos que hay dos grupos diferenciados, uno en el que hay una alta desproporción, que serían los métodos Imperiali, Adams, D´Hondt y Huntington-Hill y otro en el que la desproporción es baja.
En España, la concentración de voto suele ser alta o medio-alta y se utiliza como método de reparto el método D´Hondt, por lo tanto observando el gráfico podemos decir que el método utilizado en España no es el más óptimo si se busca obtener un bajo índice de desproporción, sería conveniente realizar un cambio de método y cambiar el método D´Hondt preferentemente por el método Sainte-Lague o Danish, que son los mejores entre los métodos del grupo de promedio mayor con desproporción baja. Dentro del grupo de los métodos de resto mayor todos ellos se comportan con una desproporción muy baja.





```{r eval=FALSE, include=FALSE}

## Comparaciones variando escaños y nº partidos a la vez

desproporción <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    o
  }


asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 1:n_escannos
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}



# Crear lista con partidos
partidos <- NULL
for (i in (seq_len(100) + 1)) {
  partidos[[i - 1]] <- paste("Partido_", seq_len(i), sep = "")
}

# Fijar el número de escaños
n_escannos <- seq_len(800)

# Nivel de concentración del voto, 1 igualado, 1000 desigualdad máxima
expon <- seq(from = 0.001, to = 1, length.out = 1000)


# Crear lista con Votos modificado
# Cambiar expon para la distrubución de los votos, por igualdad baja a alta
votos_alto <- NULL
votos_medio <- NULL
votos_bajo <- NULL
votos <- NULL
for (i in seq_len(100)) {
  votos[[i]] <- trunc(rep(x = 10e5, length(partidos[[i]])))
  votos_alto[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[500])
  votos_medio[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[100])
  votos_bajo[[i]] <- votos[[i]] * dexp(seq_len(length(partidos[[i]])), rate = expon[1])
}

## Diferencia votos alto ####

# Cálculo de los escaños y de la desproporción
iter <- 1
resul_alto <- NULL
dis_alto <- numeric()
resul_medio <- NULL
dis_medio <- numeric()
resul_bajo <- NULL
dis_bajo <- numeric()

for (j in n_escannos) {
  for (i in seq_len(length(partidos))) {
    # Alto
    resul_alto[[iter]] <- asientos_dhondt(partidos[[i]], votos_alto[[i]], n_escannos[[j]], couta_min = 0)$Escanos
    dis_alto[iter] <- desproporción(s = resul_alto[[iter]], v = votos_alto[[i]])
    # Bajo
    resul_bajo[[iter]] <- asientos_dhondt(partidos[[i]], votos_bajo[[i]], n_escannos[[j]], couta_min = 0)$Escanos
    dis_bajo[iter] <- desproporción(s = resul_bajo[[iter]], v = votos_bajo[[i]])
    # Medio
    resul_medio[[iter]] <- asientos_dhondt(partidos[[i]], votos_medio[[i]], n_escannos[[j]], couta_min = 0)$Escanos
    dis_medio[iter] <- desproporción(s = resul_medio[[iter]], v = votos_medio[[i]])
    iter <- iter + 1
  }
}

# Saber el núm de escaños y partidos para cada desproporción
num_escannos <- sapply(resul_alto, sum)
num_partidos <- sapply(resul_alto, length)

despro_alto <- data.table("Escaños" = num_escannos, "Partidos" = num_partidos, "Desproporcion" = dis_alto)


graf_alto <- ggplot(data = despro_alto, mapping = aes(Escaños, Partidos)) +
  geom_raster(aes(fill = log(Desproporcion))) +
  theme(legend.position = "none")
# scale_fill_gradient(low = "red", high = "yellow") +
# labs(subtitle = "Diferencia entre votos alta", title = "Desproporción según LR imperialilr", caption = "Elaboración propia: Angel González", x = "Escaños")


### Distribución media ####

# Cálculo de los escaños y de la desproporción
# resul_medio <- NULL
# iter <- 1
# dis_medio <- numeric()
# for (j in n_escannos) {
#   for (i in seq_len(length(partidos))) {
#     resul_medio[[iter]] <- asientos_dhondt(partidos[[i]], votos_medio[[i]], n_escannos[[j]], couta_min = 0)$Escanos
#     dis_medio[iter] <- desproporción(s = resul_medio[[iter]], v = votos_medio[[i]])
#     iter <- iter + 1
#   }
# }

# Saber el núm de escaños y partidos para cada desproporción
num_escannos <- sapply(resul_medio, sum)
num_partidos <- sapply(resul_medio, length)

despro_media <- data.table("Escaños" = num_escannos, "Partidos" = num_partidos, "Desproporcion" = dis_medio)


graf_medio <- ggplot(data = despro_media, mapping = aes(Escaños, Partidos)) +
  geom_raster(aes(fill = log(Desproporcion))) +
  theme(legend.position = "none")
# scale_fill_gradient(low = "red", high = "yellow") +
# labs(subtitle = "Diferencia entre votos media", title = "Desproporción según LR imperialilr", caption = "Elaboración propia: Angel González", x = "Escaños")


## Diferencia votos bajo ####

# Cálculo de los escaños y de la desproporción
# resul_bajo <- NULL
# iter <- 1
# dis_bajo <- numeric()
# for (j in n_escannos) {
#   for (i in seq_len(length(partidos))) {
#     resul_bajo[[iter]] <- asientos_dhondt(partidos[[i]], votos_bajo[[i]], n_escannos[[j]], couta_min = 0)$Escanos
#     dis_bajo[iter] <- desproporción(s = resul_bajo[[iter]], v = votos_bajo[[i]])
#     iter <- iter + 1
#   }
# }

# Saber el núm de escaños y partidos para cada desproporción
num_escannos <- sapply(resul_bajo, sum)
num_partidos <- sapply(resul_bajo, length)

despro_bajo <- data.table("Escaños" = num_escannos, "Partidos" = num_partidos, "Desproporcion" = dis_bajo)


graf_bajo <- ggplot(data = despro_bajo, mapping = aes(Escaños, Partidos)) +
  geom_raster(aes(fill = log(Desproporcion))) +
  theme(legend.position = "none")
# labs(subtitle = "Diferencia entre votos baja", title = "Desproporción según LR imperialilr", caption = "Elaboración propia: Angel González", x = "Escaños")


library(grid)
grid.newpage()
grid.draw(rbind(ggplotGrob(graf_bajo), ggplotGrob(graf_medio), ggplotGrob(graf_alto), size = "last"))

# 
# library(plotly)
# fig <- plot_ly(despro_alto, x = ~Escaños, y = ~Partidos, z = ~log(Desproporcion),
#                marker = list(color = ~Escaños, colorscale = c('#FFE1A1', '#683531'), showscale = TRUE))
# fig <- fig %>% add_markers()
# fig
```



## Conclusiones 



En general podemos concluir que una vez comparados todos los métodos tanto modificando el número de escaños a repartir, en número de partidos que se presentan a la elección y la concentración de los votos, concluimos que los mejores métodos dentro del grupo de promedios mayores son en primer lugar el método Saint-Lague, seguido por el Modified Sainte-Lague y el Danish.
En el caso del método utilizado actualmente en España, el método D´hondt, podemos decir que es un método que no siendo de los peores se queda en un nivel medio, es decir, que no es un método que se debiese usar si lo que se busca es obtener el máximo nivel de proporcionalidad, no es el mejor en ninguno de las posibles modificaciones que se presentan en este estudio, siendo entonces conveniente para España cambiar el método de reparto de escaños y utilizar dentro del grupo de promedios mayores el método de Sainte-Lague que es el que consistentemente ha presentado los mejores resultados.
Entre los métodos de resto mayor todos ellos presentan un comportamiento muy similar por lo que podría utilizarse cualquiera de ellos.


```{r message=FALSE, warning=FALSE}
knitr::write_bib(c(
  "knitr", "rmarkdown", "dplyr", "ggplot2", "xtable",
  "stringr", "shiny", "flexdashboard", "htmlwidgets",
  "bookdown", "tidyselect", "tibble", "scales"
),
file = "bib/paquetemio.bib",
width = 60
)
```
