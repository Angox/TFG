---
author: "Angel Gonzalez Rizo"
date: "2021"
documentclass: book
forprint: true  # true: imprime a dos caras, false: libro digital
fontsize: 12pt # 10pt,11pt
geometry: margin = 2.5cm 
bibliography: ["bib/library.bib", "bib/paquetes.bib"]
# metodobib -> true: natbib (descomentar: citation_package: natbib) 
#           -> false: pandoc (comentar: citation_package: natbib)
metodobib: true
#natbib: plainnat, abbrvnat, unsrtnat
biblio-style: "plainnat"
#Método 2 (pandoc): descomente una línea de las 2 siguientes en caso de usarlo
csl: methods-in-ecology-and-evolution.csl      # no numera mejor en las citas
#csl: acm-sig-proceedings-long-author-list.csl  # numera peor en las citas
link-citations: yes
output: 
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib  # comentado usa: pandoc-citeproc
    #toc: yes
    fig_caption: yes
    template: latex/templateMemoriaTFE.tex
    includes:
      #before_body: portadas/latex_paginatitulo_modTFE.tex
      #in_header: latex/latex_preambulo.tex
      #after_body: latex/latex_antes_enddoc.tex
editor_options: 
  chunk_output_type: inline
---



```{r include=FALSE}
knitr::opts_chunk$set(
  fig.path = "figurasR/",
  echo = FALSE, warning = FALSE, message = FALSE,
  fig.pos = "H", fig.align = "center", out.width = "95%",
  cache = FALSE
)
```


<!-- \setcounter{chapter}{2} -->
<!-- \setcounter{chapter}{2} escribir 2 para capítulo 3  -->
<!-- \pagenumbering{arabic} -->

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents
<!-- \nocite{*} -->
\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}



# Análisis empírico método reparto de escaños

## Según nº partidos, densidad y nº de escaños a repartir

Vamos a simular distintos escenarios para analizarlos según los distintos métodos de reparto de escaños. 

Los sistemas que analizaremos en este análisis emprírico serán, dentro de los métodos de promedio mayor, el método D´Hondt, método Saint-Lague, método Saint-Lague modificado, el método Huntington-Hill, el método Imperiali, Danish y Adams. 
<!-- Dentro de los métodos de resto mayor analizaremos el método Hagenbach-Bischoff, Droop, Hare e Imperiali. Dentro de los métodos mayoritario analizaremos únicamente el método de mayoría simple. -->

Generaremos datos ficticios de partidos, que irán desde 2 posibles partidos hasta 500 partidos, en países como India podemos observar que se presentan a las elecciones hasta 2698 partidos, número de escaños que irán desde 1 posible escaño a repartir a 800 escaños a repartir, como podemos observar en países como Reino Unido o más aún escaños, hasta 2987 en China, y según diferentes densidades desde una máxima desigualdad en votos entre los partidos hasta una máxima igualdad de votos entre partidos.



```{r}

library(ggplot2)

n_partidos <- seq_len(50)[-1]

densidad <- rep(length(n_partidos), 100)

n_escannos <- seq_len(50)
```


### D`Hondt
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 1:n_escannos
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### D`Hondt variando el número de escaños

```{r}
# D`Hondt Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   # n_escannos <- i # Variable
#   # votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, i, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### D`Hondt Desproporción -->

```{r}
desproporción <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


# desproporción(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_dhondt <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según D`Hondt", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando.
La diferencia de desproporción en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños se va reduciendo, a números altos de escaños a repartir la desproporción tiende a estabilizarse.

#### D`Hondt variando el número de partidos

```{r}
# D`Hondt Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_dhondt <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según D`Hondt", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 o 3 partidos a las elecciones la desproporción es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción con 6 partidos que se presentan a las elecciones, a partir de el séptimo partido la curva comienza a decrecer.
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 4 a 60 ) la desproporción es alta pero decreciente, cuanto mayor número de partidos se presentan en las elcciones menor es la desproporción que encontramos, como en el apartado anterior, la desproporción tiende a estabilizarse.



#### D`Hondt variando la distribución de los votos

```{r}
# D`Hondt Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Desproporción",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_dhondt <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Desproporción según D`Hondt", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.
Observando el gráfico observamos que cuando la concentración del voto es muy baja la desproporción está en un nivel bajo, cuanto más concentración de voto podemos comprobar como la desproporción aumenta hasta que alcanza un punto en donde alcanza el máximo de desproporción y a partir de ese punto la desproporción va bajando.
Así podemos concluir que el reparto de escaños según la ley D`Hondt es mejor cuanto más concentración de voto tengan unos pocos partidos con respecto a los demás.





### Sainte-Lague
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 2 * (1:n_escannos) - 1
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Sainte-Lague variando el número de escaños

```{r}
# Sainte-Lague Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Sainte-Lague Desproporción -->
  
```{r}
desproporción <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#desproporción(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_sl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando.
La diferencia de desproporción en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la desproporción tiende a estabilizarse.

#### Sainte-Lague variando el número de partidos

```{r}
# Sainte-Lague Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_sl <- dis1


ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 partidos a las elecciones la desproporción es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción con 2 partidos que se presentan a las elecciones, a partir de el séptimo partido la curva comienza a decrecer.
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 4 a 6 ) la desproporción es alta pero decreciente, cuanto mayor número de partidos se presentan en las elcciones menor es la desproporción que encontramos, como en el apartado anterior, la desproporción tiende a estabilizarse.



#### Sainte-Lague variando la distribución de los votos

```{r}
# Sainte-Lague Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Desproporción",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_sl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Desproporción según Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.
Observando el gráfico observamos que cuando la concentración del voto es muy baja la desproporción está en un nivel alto, aumenta levemente para una concentración baja-media y a partir de ahí, donde alcanza el máximo de desproporción, la curva va decreciendo cuanto mas diferencia de votos entre partidos exista.
Así podemos concluir que el reparto de escaños según la ley Sainte-Lague es mejor cuanto más concentración de voto tengan unos pocos partidos con respecto a los demás.


### Modified Sainte-Lague
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- c(1, (10 * (2:n_escannos) - 5) / 7)
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Modified Sainte-Lague variando el número de escaños

```{r}
# Modified Sainte-Lague Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Modified Sainte-Lague Desproporción -->
  
```{r}
desproporción <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#desproporción(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_msl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Modified Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando.
La diferencia de desproporción en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la desproporción tiende a estabilizarse.

#### Modified Sainte-Lague variando el número de partidos

```{r}
# Modified Sainte-Lague Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_msl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Modified Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 o 3 partidos a las elecciones la desproporción es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción con 6 partidos que se presentan a las elecciones, a partir de el séptimo partido la curva comienza a decrecer.
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 2 a 6 ) la desproporción es alta pero decreciente, cuanto mayor número de partidos se presentan en las elcciones menor es la desproporción que encontramos, como en el apartado anterior, la desproporción tiende a estabilizarse.



#### Modified Sainte-Lague variando la distribución de los votos

```{r}
# Modified Sainte-Lague Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Desproporción",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_msl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Desproporción según Modified Sainte-Lague", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.
Observando el gráfico observamos que cuando la concentración del voto es muy baja la desproporción está en un nivel medio, cuanto más concentración de voto podemos comprobar como la desproporción aumenta hasta que alcanza un punto en donde alcanza el máximo de desproporción y a partir de ese punto la desproporción va bajando.
Así podemos concluir que el reparto de escaños según la ley Modified Sainte-Lague es mejor cuanto más concentración de voto tengan unos pocos partidos con respecto a los demás.


### Imperiali
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- ((1:n_escannos) + 1) / 2
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Imperiali variando el número de escaños

```{r}
# Imperiali Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Imperiali Desproporción -->
  
```{r}
desproporción <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#desproporción(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_imp <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Imperiali", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando.
La diferencia de desproporción en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la desproporción tiende a estabilizarse.

#### Imperiali variando el número de partidos

```{r}
# Imperiali Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_imp <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Imperiali", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 o 3 partidos a las elecciones la desproporción es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción con 6 partidos que se presentan a las elecciones, a partir del séptimo partido la curva comienza a decrecer.
Entonces, según el modelo Imperiali tendremos una menor desproporción según se vayan aumentando el número de partidos.



#### Imperiali variando la distribución de los votos

```{r}
# Imperiali Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Desproporción",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_imp <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Desproporción según Imperiali", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.
Observando el gráfico observamos que cuando la concentración del voto es muy baja la desproporción está en un nivel bajo, cuanto más concentración de voto podemos comprobar como la desproporción aumenta hasta que alcanza un punto en donde alcanza el máximo de desproporción y a partir de ese punto la desproporción va bajando.
Así podemos concluir que el reparto de escaños según la ley Imperiali obtiene su menor desproporción en los escenarios en donde la diferencia de votos entre los partidos sea muy baja.


### Huntington-Hill
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- sqrt((1:n_escannos) * ((1:n_escannos) - 1))
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Huntington-Hill variando el número de escaños

```{r}
# Huntington-Hill Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Huntington-Hill Desproporción -->
  
```{r}
desproporción <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#desproporción(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_hh <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Huntington-Hill", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta,es interesante observar que para un número de escaños entre 1 y 50 la desproporción no cambia, es a partir de los 50 escaños y posteriores donde observamos el descenso de la desproporción, descenso rápido en los primeros escaños que tiende a estabilizarse cuanto mayor número de escaños se repartan.


#### Huntington-Hill variando el número de partidos

```{r}
# Huntington-Hill Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_hh <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Huntington-Hill", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.

Observamos que cuando se presentan 2 o 3 partidos a las elecciones la desproporción es media, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción con 50 partidos que se presentan a las elecciones, a partir de 50 partidos la curva comienza a decrecer.

Lo particular de este método respecto a otros métodos es que la menor desproporción no se obtiene en el caso de que se presenten a las elecciones pocos partidos, sino que la menor desproporción se obtiene cuanto más partidos se presenten a las elecciones.


#### Huntington-Hill variando la distribución de los votos

```{r}
# Huntington-Hill Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Desproporción",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_hh <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Desproporción según Huntington-Hill", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.

Observando el gráfico observamos que cuando la concentración del voto es muy baja la desproporción está en un nivel bajo, desproporción que se mantiene baja cuando la concentración de los votos es baja, y que a partir de una concentración de votos medio-baja la desproporción va aumentando cuanto más diferencia de votos entre partidos se presenten.

Así podemos concluir que el reparto de escaños según la ley Huntington-Hill es mejor cuanto menor concentración de voto tengan los partidos entre ellos, presenta un comportamiento diferente respecto a los otros métodos en donde cuanto mayor concentración de votos menor desproporción.


### Adams
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 1:n_escannos - 1
  div[is.na(div)] <- 0
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Adams variando el número de escaños

```{r}
# Adams Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Adams Desproporción -->

```{r}
desproporción <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#desproporción(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_ad <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Adams", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, en este método también observamos que la desproporción se mantiene en un mismo nivel hasta los 50 escaños, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando.
La diferencia de desproporción en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la desproporción tiende a estabilizarse.

#### Adams variando el número de partidos

```{r}
# Adams Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_ad <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Adams", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.

Observamos que cuando se presentan 2 o 3 partidos a las elecciones la desproporción es media, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción con 50 partidos que se presentan a las elecciones, a partir de los 50 partidos que se presentan a las elecciones la curva comienza a decrecer.

Entonces según el método Adams obtenemos el mejor resultado cuanto mayor número de partidos  se presenten a las elecciones.


#### Adams variando la distribución de los votos

```{r}
# Adams Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Desproporción",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_ad <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Desproporción según Adams", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.

Observando el gráfico observamos que cuando la concentración del voto es muy baja la desproporción está en un nivel bajo, cuanto más concentración de voto podemos comprobar como la desproporción va aumentando cada vez con una diferencia decreciente.

Así podemos concluir que el reparto de escaños según la ley Adams es mejor cuanto menor concentración de voto los partidos entre ellos, y será peor cuanto mayor concentración de voto se presente.

### Danish
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 3 * (1:n_escannos) - 2
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Danish variando el número de escaños

```{r}
# Danish Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Danish Desproporción -->
  
```{r}
desproporción <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#desproporción(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:800], MARGIN = 2, FUN = function(x) desproporción(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_esc_dan <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción según Danish", caption = "Elaboración propia: Angel González", x = "Número de Escaños")
```

En este caso se nos presenta la desproporción variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la desproporción en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la desproporción va bajando.
La diferencia de desproporción en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de desproporción entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la desproporción tiende a estabilizarse.

#### Danish variando el número de partidos

```{r}
# Danish Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporción columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- desproporción(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_par_dan <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Desproporción según Danish", caption = "Elaboración propia: Angel González", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 o 3 partidos a las elecciones la desproporción es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de desproporción con 6 partidos que se presentan a las elecciones, a partir de el séptimo partido la curva comienza a decrecer.
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 4 a 6 ) la desproporción es alta pero decreciente, cuanto mayor número de partidos se presentan en las elecciones menor es la desproporción que encontramos, como en el apartado anterior, la desproporción tiende a estabilizarse.

Entonces según el método Danish obtenemos el mejor resultado cuanto más partidos se presenten a las elecciones.



#### Danish variando la distribución de los votos

```{r}
# Danish Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporción columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- desproporción(s = resul1[[i]], v = vot[[i]])
}
# desproporción(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) desproporción(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Desproporción",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Desproporción" = dis, "Escannos" = seq_len(length(dis)))
var_dis_dan <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Desproporción)) +
  geom_point(data = dis1, mapping = aes(color = Desproporción), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Desproporción según Danish", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.

Observando el gráfico observamos que cuando la concentración del voto es muy baja la desproporción está en un nivel medio, cuanto más concentración de voto podemos comprobar como la desproporción aumenta hasta que alcanza un punto en donde alcanza el máximo de desproporción y a partir de ese punto la desproporción va bajando.

Así podemos concluir que el reparto de escaños según la ley Danish es mejor cuanto más concentración de voto tengan unos pocos partidos con respecto a los demás.

## Comparaciones entre métodos

### Variando el número de escaños
```{r}
var_esc_dhondt$Metodo <- "D`Hondt"
var_esc_sl$Metodo <- "Sainte-Lague"
var_esc_msl$Metodo <- "Modified Sainte-Lague"
var_esc_imp$Metodo <- "Imperiali"
var_esc_hh$Metodo <- "Huntington-Hill"
var_esc_ad$Metodo <- "Adams"
var_esc_dan$Metodo <- "Danish"

var_esc <- rbind(var_esc_dhondt, var_esc_sl, var_esc_msl, var_esc_imp, var_esc_hh, var_esc_ad, var_esc_dan)

# ggplot(data = var_esc, mapping = aes(Escannos, Desproporción)) +
#   # geom_point(data = var_esc, mapping = aes(fill = "Metodo"), show.legend = F) +
#   geom_point() +
#   facet_grid(cols = vars(Metodo)) +
#   scale_fill_gradient(low = "red", high = "yellow") +
#   labs(subtitle = "Variando la distribución de los votos", title = "Desproporción según Danish", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")

ggplot(data = var_esc, mapping = aes(Escannos, Desproporción)) +
  geom_point(aes(colour = factor(Metodo)))+
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción ", caption = "Elaboración propia: Angel González", x = "Número de Escaños")+
  # labs(title = "Variando la distribución de los votos", subtitle = "Desproporción", caption = "Elaboración propia: Angel González", x = "Número de Escaños")+
  guides(color=guide_legend(title="Método"))+
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )

```

En el presente gráfico comparamos en un mismo lugar los métodos anteriormente analizados individualmente.
En esta comparación podemos observar que para todos los métodos la desproporción baja cuanto mayor número de escaños a repartir, los peores métodos en este caso serían el Adams y el Imperiali, el método Adams cuando tengamos un número de escaños menor y el Imperiali a partir aproximadamente de los 100 escaños.
Los mejores métodos en este caso serían el método de Sainte-Lague y el método Danish.


```{r}
var_esc_dhondt$Metodo <- "D`Hondt"
var_esc_sl$Metodo <- "Sainte-Lague"
var_esc_msl$Metodo <- "Modified Sainte-Lague"
var_esc_imp$Metodo <- "Imperiali"
var_esc_hh$Metodo <- "Huntington-Hill"
var_esc_ad$Metodo <- "Adams"
var_esc_dan$Metodo <- "Danish"

var_esc <- rbind(var_esc_dhondt, var_esc_sl, var_esc_msl, var_esc_imp, var_esc_hh, var_esc_ad, var_esc_dan)

# ggplot(data = var_esc, mapping = aes(Escannos, Desproporción)) +
#   # geom_point(data = var_esc, mapping = aes(fill = "Metodo"), show.legend = F) +
#   geom_point() +
#   facet_grid(cols = vars(Metodo)) +
#   scale_fill_gradient(low = "red", high = "yellow") +
#   labs(subtitle = "Variando la distribución de los votos", title = "Desproporción según Danish", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")

ggplot(data = var_esc[var_esc$Escannos>300&var_esc$Escannos<400,], mapping = aes(Escannos, Desproporción)) +
  geom_point(aes(colour = factor(Metodo)))+
  labs(subtitle = "Variando el número de escaños a repartir", title = "Desproporción ", caption = "Elaboración propia: Angel González", x = "Número de Escaños")+guides(color=guide_legend(title="Método"))+
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )

```

En este gráfico nos centramos en la desproporción para un número de escaños a repartir de entre 300 y 400 diputados, actualmente en España se reparten 350 diputados.
El peor método entre los presentados es el método Imperiali, con una diferencia significatica respecto a los demás métodos. Los mejores métodos de reparto podemos agruparlos en un grupo de tres, que son el método de Sainte-Lague en primer lugar, el método Modified Sainte-Lague y el método Danish respectivamente.
Podemos agrupar los métodos en tres grupos,un grupo que sería el de una desproporción baja, en el que se encontrarían los métodos de Sainte-Lague, Danish y Modified Sainte-Lague.
Un segundo grupo que sería el que presentaría una desproporción media, con los métodos Adams, Huntington-Hill y D´Hondt, finalizando con un último grupo de desproporción alta, y debido a ello no deseable en el que estaría el método Imperiali.

Actualmente en España se reparten 350 escaños y se utiliza el método D´Hondt, según los datos obtenidos podemos decir que no es el mejor método que se puede utilizar, es un método que está en el grupo de desproporción media, e incluso no es el mejor método dentro de ese subgrupo, sería interesante según lo observado en la gráfica plantearse un cambio de método a otro mejor, al menos a alguno dentro del subgrupo de desproporción baja, preferentemente el mejor método que podríamos utilizar, que sería el método de Sainte-Lague sin modificar.

### Variando el número de partidos
```{r}
var_par_dhondt$Metodo <- "D`Hondt"
var_par_sl$Metodo <- "Sainte-Lague"
var_par_msl$Metodo <- "Modified Sainte-Lague"
var_par_imp$Metodo <- "Imperiali"
var_par_hh$Metodo <- "Huntington-Hill"
var_par_ad$Metodo <- "Adams"
var_par_dan$Metodo <- "Danish"

var_par <- rbind(var_par_dhondt, var_par_sl, var_par_msl, var_par_imp, var_par_hh, var_par_ad, var_par_dan)


  ggplot(data = var_par, mapping = aes(Escannos, Desproporción)) +
  geom_point(aes(colour = factor(Metodo)))+
  labs(subtitle = "Variando el número de partidos", title = "Desproporción", caption = "Elaboración propia: Angel González", x = "Número de partidos") + guides(color=guide_legend(title="Método")) +
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )
```

En el presente gráfico comparamos la desproporción variando el número de partidos en un mismo lugar con los métodos anteriormente analizados individualmente.

Observamos que para un número de partidos bajo hasta los 50 partidos que se presentan a unas elecciones la desproporción es muy variable, a partir de los 50 partidos se estabiliza y podemos sacar algunas conclusiones, en primer lugar el peor método claramente en este caso es el método Adams, mientras que los demás métodos son muy similares en su desproporción, donde la menor desproporción lo podemos encontrar en el método Adams.


```{r}
var_par_dhondt$Metodo <- "D`Hondt"
var_par_sl$Metodo <- "Sainte-Lague"
var_par_msl$Metodo <- "Modified Sainte-Lague"
var_par_imp$Metodo <- "Imperiali"
var_par_hh$Metodo <- "Huntington-Hill"
var_par_ad$Metodo <- "Adams"
var_par_dan$Metodo <- "Danish"

var_par <- rbind(var_par_dhondt, var_par_sl, var_par_msl, var_par_imp, var_par_hh, var_par_ad, var_par_dan)


  ggplot(data = var_par[var_par$Escannos<50,], mapping = aes(Escannos, Desproporción)) +
  geom_point(aes(colour = factor(Metodo)))+geom_line(aes(colour = factor(Metodo)),size=1)+
  labs(subtitle = "Variando el número de partidos", title = "Desproporción", caption = "Elaboración propia: Angel González", x = "Número de partidos") + guides(color=guide_legend(title="Método")) +
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )
```

En este gráfico nos centramos en la desproporción para un número de partidos entre 2 y 50 partidos.

Observamos que hasta los 20 partidos que se presentan a las elecciones la desproporción es muy variable entre ellos, a partir de los 20 partidos que se presentan en las elecciones podemos extraer algunas conclusiones, se ven dos grupor direfenciados, un grupo en donde la desproporción es estable e incluso decreciente  y otro grupo en el que la desproporción va aumentando, que son los métodos de Adams y Huntington-Hill.

En España se utiliza el método D´Hondt, según los datos obtenidos podemos concluir que el método d´Hondt no es el mejor método entre los analizados, sería el cuarto mejor método entre siete métodos posibles, es decir, sería deseable para obtener una mayor proporcionalidad que se cambiase el método de reparto a otro mejor, en este caso observamos que el mejor método es el Saint-Lague.

### Variando la distribución de los votos
```{r}
var_dis_dhondt$Metodo <- "D`Hondt"
var_dis_sl$Metodo <- "Sainte-Lague"
var_dis_msl$Metodo <- "Modified Sainte-Lague"
var_dis_imp$Metodo <- "Imperiali"
var_dis_hh$Metodo <- "Huntington-Hill"
var_dis_ad$Metodo <- "Adams"
var_dis_dan$Metodo <- "Danish"

var_dis <- rbind(var_dis_dhondt, var_dis_sl, var_dis_msl, var_dis_imp, var_dis_hh, var_dis_ad, var_dis_dan)


  ggplot(data = var_dis, mapping = aes(Escannos, Desproporción)) +
  geom_point(aes(colour = factor(Metodo)))+
  labs(subtitle = "Variando la distribucion de los votos", title = "Desproporción", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")+guides(color=guide_legend(title="Método"))+
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )
```

En el presente gráfico comparamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande. Todo ello en un mismo lugar con los métodos anteriormente analizados individualmente.

Observamos que hay dos grupos diferenciados, uno de ellos en los que la desproporción es baja para una menor concentración de votos entre los partidos y que a medida que la concentración aumenta también va aumentando la desproporción, donde se encuentran los métodos de Adams y Huntington-Hill. El otro grupo se caracteriza por en cuanto la concentración del voto es muy baja la desproporción está en un nivel bajo, cuanto más concentración de voto podemos comprobar como la desproporción aumenta hasta que alcanza un punto en donde alcanza el máximo de desproporción y a partir de ese punto la desproporción va bajando alcanzando el mínimo de desproporción.

```{r}
var_dis_dhondt$Metodo <- "D`Hondt"
var_dis_sl$Metodo <- "Sainte-Lague"
var_dis_msl$Metodo <- "Modified Sainte-Lague"
var_dis_imp$Metodo <- "Imperiali"
var_dis_hh$Metodo <- "Huntington-Hill"
var_dis_ad$Metodo <- "Adams"
var_dis_dan$Metodo <- "Danish"

var_dis <- rbind(var_dis_dhondt, var_dis_sl, var_dis_msl, var_dis_imp, var_dis_hh, var_dis_ad, var_dis_dan)


  ggplot(data = var_dis[var_dis$Escannos>400,], mapping = aes(Escannos, Desproporción)) +
  geom_point(aes(colour = factor(Metodo)))+
  labs(subtitle = "Variando la distribucion de los votos", title = "Desproporción", caption = "Elaboración propia: Angel González", x = "Concentración (menor a mayor)")+guides(color=guide_legend(title="Método"))+
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )
```


En este gráfico nos centramos en los casos en que hay mayor concentración de votos de unos pocos partidos, lo que suele suceder actualmente.
Vemos que hay dos grupos diferenciados, uno en el que hay una alta desproporción, que serían los métodos Adams y Huntington-Hill y otro en el que la desproporción es baja.
En España actualmente la concentración de voto en alta o medio-alta y se utiliza el método de D´Hondt, por lo tanto observando el gráfico podemos decir que el método utilizado en España no es el más optimo en el caso de la concentración de voto actual en España, sería conveniente realizar un cambio de método y cambiarlo preferentemente por el método Sainte-Lague, que es el mejor entre los métodos del grupo con desproporción baja.




## Conclusiones 



En general podemos concluir que una vez comparados todos los métodos tanto modificando el número de escaños a repartir, en número de partidos que se presentan a la elección y la concentración de los votos, concluimos que el mejor método es el Saint-Lague, seguido por el Modified Sainte-Lague y el Danish.
En el caso del método utilizado actualmente en España, el método D´hondt, podemos decir que es un método que no siendo de los peores se queda en un medio que no es ni un método malo ni bueno, es decir, que no es un método que se debiese usar, puesto que no es el mejor en ninguno de las posibles modificaciones que se presentan en este estudio, siendo entonces conveniente para España cambiar el método de reparto de escaños y utilizar el método de Sainte-Lague que es el que consistentemente ha presentado los mejores resultados.


```{r message=FALSE, warning=FALSE}
knitr::write_bib(c("knitr","rmarkdown","dplyr","ggplot2","xtable",
"stringr","shiny","flexdashboard","htmlwidgets",
"bookdown","tidyselect","tibble","scales"),
file="bib/paquetemio.bib",
width = 60)
```

