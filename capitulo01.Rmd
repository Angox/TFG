---
author: "Angel Gonzalez Rizo"
date: "2020"
documentclass: book
forprint: true  # true: imprime a dos caras, false: libro digital
fontsize: 12pt # 10pt,11pt
geometry: margin = 2.5cm 
bibliography: ["bib/library.bib", "bib/paquetes.bib"]
# metodobib -> true: natbib (descomentar: citation_package: natbib) 
#           -> false: pandoc (comentar: citation_package: natbib)
metodobib: true
#natbib: plainnat, abbrvnat, unsrtnat
biblio-style: "plainnat"
#Método 2 (pandoc): descomente una línea de las 2 siguientes en caso de usarlo
csl: methods-in-ecology-and-evolution.csl      # no numera mejor en las citas
#csl: acm-sig-proceedings-long-author-list.csl  # numera peor en las citas
link-citations: yes
output: 
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib  # comentado usa: pandoc-citeproc
    #toc: yes
    fig_caption: yes
    template: latex/templateMemoriaTFE.tex
    includes:
      #before_body: portadas/latex_paginatitulo_modTFE.tex
      #in_header: latex/latex_preambulo.tex
      #after_body: latex/latex_antes_enddoc.tex
editor_options: 
  chunk_output_type: inline
---



```{r include=FALSE}
knitr::opts_chunk$set(
  fig.path = "figurasR/",
  echo = FALSE, warning = FALSE, message = FALSE,
  fig.pos = "H", fig.align = "center", out.width = "95%",
  cache = FALSE
)
```


<!-- \setcounter{chapter}{2} -->
<!-- \setcounter{chapter}{2} escribir 2 para capítulo 3  -->
<!-- \pagenumbering{arabic} -->

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents
<!-- \nocite{*} -->
\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}



# Introducción

## Objetivos

Rev-El objetivo del presente trabajo será analizar los distintos sistemas de votación que existen en la actualidad que puedan ser aplicados actualmente en España, aplicar estos sistemas a España, indicando sus ventajas e inconvenientes y proponer nuevos sistemas de votación o reparto para una eventual reforma de la Ley Orgánica del Régimen Electoral.

## ¿Qué significa votar?

### Origen

Según la Real Academia de la Lengua Española votar proviene de la palabra latina votare (hacer votos, hacer ofrendas religiosas), es un verbo formado a partir del latín votum, originalmente una ofrenda religiosa o promesa a los dioses con objeto de lograr algo deseado, que luego pasaría a significar un deseo expreso. Tiempo después pasó al terreno político, en latín propiamente el voto político se denomina suffragium. Votum es un nombre a partir del verbo vovere ( hacer un exvoto u ofrenda religiosa). De este verbo latino se derivan también votivo, exvoto, devoto y devoción.

### Significado

En su primera acepción en el diccionario de la Real Academia de la Lengua Española define votar como: "Dicho de una persona: Dar su voto o decir su dictamen en una reunión o cuerpo deliberante, o en una elección de personas." 

-Rev-es la misma def--Para terminar de definir mejor el término buscamos la definición en el diccionario del español jurídico, en el cual en la primera acepción nos resulta útil para la delimitación del término que queremos definir, en su primera acepción lo define como: "Dicho de una persona: Dar su voto o decir su dictamen en una reunión o cuerpo deliberante, o en una elección de personas." 

### ¿Votación o sufragio?

Las dos palabras son sinónimas, aunque en la segunda acepción de la palabra sufragio según la Real Academia de la lengua: "Sistema electoral para la provisión de cargos" nos referimos más al voto como sistema, y en el voto se entiende más como referencia a la persona que realiza el acto de votar.
A lo largo del trabajo trataremos indistintamente ambos términos.


## Sistema electoral en España

### Orígenes 

El origen de el sistema electoral español se remonta a principios del siglo XIX, en una España invadida por el ejército de Napoleón. El vacío de poder facilitó la convocatoria de una asamblea nacional, las cortes, en la ciudad de Cádiz con diputados venidos de todas las regiones tanto de la península como de ultramar. La asamblea concluyó con la promulgación de la constitución de 1812.

En la instrucción de 1810 comienzan a aparecer los mecanismos para elegir a los representantes tanto parroquiales, de partido y de provincia. La fórmula electoral escogida fue la mayoritaria. El sufragio es masculino universal e indirecto, aunque se requería que los electores ejerciesen algún tipo de industria.
Ya en la constitución de 1812 se reguló todo el proceso electoral en los artículos 27 a 103, se determinó una distribución de 1 diputado por cada 70.000 personas.

Formalmente las leyes que regulan el derecho de sufragio se remontan a 1837, estableciéndose en el año 1869 el sufragio universal consolidado en 1907 por ley.

### Sistema electoral de la constitución de 1978

El sistema actual español se rige bajo tres normas, en primer lugar la misma constitución de 1978, y mas tarde la Ley Orgánica del Régimen Electoral Central 5/1985, de 19 de Junio, en donde se regula las elecciones al Parlamento Europeo, al Congreso y Senado y las elecciones de los municipios y la del 2/2011, del 28 de Enero en donde se modifica la anterior Ley Orgánica. 

### Descripción del sistema Electoral Español

La descripción del sistema Electoral Español se encuentra el la LOREG (Ley Orgánica del Régimen Electoral Español).  

En el caso de España debemos diferenciar la elección de Diputados y Senadores, cada provincia es considerada como una circunscripción electoral. Como excepción a la regla las ciudades de Ceuta y Melilla son consideradas cada una de ellas como una circunscripción electoral.  

En el artículo 161.2 se nos añade otra excepción para la elección de Senadores en donde se consideran circunscripciones las siguientes islas o agrupaciones de islas: Mallorca, Menorca, Ibiza-Formentera, Gran Canaria, Fuerteventura, Lanzarote, Tenerife, Hierro, Gomera y La Palma.  


### Congreso

#### Número diputados

- El congreso está formado por un número fijo de diputados, 350.
- Cada una de las provincias les corresponden inicialmente al menos dos diputados, excepto las excepciones anteriormente anunciadas, donde Ceuta y Melilla están representadas por un diputado cada una de ellas.
- Los 248 diputados restantes se distribuyen entre las provincias proporcionalmente a su  población según el siguiente método:

    1. $\textrm{Cuota de Reparto} = \frac{248}{\text{Total de la poblaci\'{o}n de derecho de las provincias peninsulares e insulares}}$
      
      
      
    2. $\textrm{Diputados} = \text{Entero} \left\{\frac{\text{Población de derecho provincial}}{\text{Cuota de Reparto}}\right\}$
      
      
    3. Diputados Restantes = 348 - Número Diputados paso 2  
       Diputados Totales = Diputados + Restantes, uno a cada una de las provincias cuyo cociente, obtenido conforme al punto anterior, tenga una fracción decimal mayor. 

#### Reparto de Escaños

- Se aplica la llamada ley D´Hondt

- No se tienen en cuenta aquellas candidaturas que no hubieran obtenido, al menos, el 3% de los votos válidos emitidos en la circunscripción.

-  Se ordenan de mayor a menor, en una columna, las cifras de votos obtenidos por las restantes candidaturas.

-  Se divide el número de votos obtenidos por cada candidatura por 1, 2, 3, etc., hasta un número igual al de escaños correspondientes a la circunscripción. Los escaños se atribuyen a las candidaturas que obtengan los cocientes mayores, atendiendo a un orden decreciente.

    +  Cuando en la relación de cocientes coincidan dos correspondientes a distintas candidaturas, el escaño se atribuirá a la que mayor número total de votos hubiese obtenido.

- Los escaños correspondientes a cada candidatura se adjudican a los candidatos incluidos en ella, por el orden de colocación en que aparezcan.

- En las circunscripciones de Ceuta y Melilla será proclamado electo el candidato que mayor número de votos hubiese obtenido.

### Senado

- En cada circunscripción provincial se eligen cuatro Senadores.

- En cada circunscripción insular se elige el siguiente número de Senadores: tres en Gran Canaria, Mallorca y Tenerife; uno en Ibiza-Formentera, Menorca, Fuerteventura, Gomera, Hierro, Lanzarote y La Palma.

- Las Poblaciones de Ceuta y Melilla eligen cada una de ellas dos Senadores.

-  Las Comunidades Autónomas designan además un Senador y otro más para cada millón de habitantes de su respectivo territorio. La designación corresponde a la Asamblea Legislativa de la Comunidad Autónoma, de acuerdo con lo que establezcan sus Estatutos, que aseguran, en todo caso, la adecuada representación proporcional. A efectos de dicha designación el número concreto de Senadores que corresponda a cada Comunidad Autónoma se determinará tomando como referencia el censo de población de derecho vigente en el momento de celebrarse las últimas elecciones generales al Senado.

- La elección directa de los Senadores en las circunscripciones provinciales, insulares y en Ceuta y Melilla se rige por lo dispuesto en los apartados siguientes:

    a) Los electores pueden dar su voto a un máximo de tres candidatos en las circunscripciones provinciales, dos en Gran Canaria, Mallorca, Tenerife, Ceuta y Melilla, y uno en las restantes circunscripciones insulares.

    b) Serán proclamados electos aquellos candidatos que obtengan mayor número de votos hasta complementar el de Senadores asignados a la circunscripción.


# Métodos de reparto de escaños



## Método de cifra repartidora

Sistema utilizado para repartir los escaños de manera no puramente proporcional a el número de votos obtenidos por las diferentes candidaturas. El método trata de asignar los escaños proporcionalmente al número de votos recibidos, es un sistema que permite a partidos con pocos votos estar representados.

Existen dos métodos basados en la cifra repartidora que son habitualmente utilizados, y que se encuentran también dentro de los llamados métodos de los restos mayores, éstos son el método D`Hondt y el Método Sainte-Laguë.

### Ley D´Hondt

La ley D´Hondt lleva el nombre del matemático y jurista belga Victor D´Hondt , el cual describió la metodología en el año 1878 en su libro *"La représentation proportionnelle des partis par un électeur"*. [^3.1]

[^3.1]: Puede leerse el línea el segundo libro del autor: *"Système pratique et raisonné de représentation proportionelle"* en  http://mat.uab.cat/~xmora/bibliografia/DHondt1882.pdf

Se trata de un método de promedio mayor, utilizado para asignar los escaños usualmente en sistemas de listas. Es un sistema que trata de asignar los escaños aproximados al número de votos recibidos y que incentiva las coaliciones de partidos.  
Es el sistema más habitualmente utilizado en las democracias actuales.

#### Reparto

Una vez escrutados la totalidad de los votos, se calculan cocientes según la fórmula:  

$\textrm{Cociente} = \frac{V}{s+1}$  donde:  

$V$: Representa el número total de votos recibidos por la lista.  

$s$: Representa el número de escaños que cada lista se ha llevado de momento, inicialmente 0 para cada lista.  

El número de votos recibidos por cada lista se divide primero por 1, después por 2, 3, hasta el número total de escaños para ese distrito.


### Método Sainte-Laguë

Método también conocido como método Webster, creado por el matemático francés André Sainte-Laguë en 1832, similar al método D`Hondt. Es un método de promedios mayores, utilizado en sistemas de votación proporcional por listas.   
El método de Sainte-Laguë es utilizado en una gran cantidad de países en los que en la actualidad [^4.2] se encuentran, entre otros, estados como Noruega, Iraq y Nueva Zelanda.  
 
[^4.2]: Cierto a la fecha de realización del trabajo.

#### Reparto 

Una vez escrutados la totalidad de los votos, se calculan cocientes según la fórmula:  

$\textrm{Cociente} = \frac{V}{2s+1}$  donde:  

$V$: Representa el número total de votos recibidos por la lista.  

$s$: Representa el número de escaños que cada lista se ha llevado de momento, inicialmente 0 para cada lista.  

El número de votos recibidos por cada lista se divide sucesivamente por cada uno de los valores que da la fórmula 2s+1 cuando s es igual a 0, 1, 2, 3, etc.; lo que supone dividir por 1, 3, 5, 7, etc. (es decir, la sucesión de números impares). La asignación de escaños se hace ordenando los cocientes de mayor a menor y asignando a cada uno un escaño hasta que estos se agoten. A diferencia de otros sistemas, el número total de votos no interviene en el cómputo.

#### Método modificado

Consiste en utilizar una fórmula distinta para el primer escaño y a partir del segundo utilizar el método habitual. La forma para el primer escaño es:

$\textrm{Cociente} = \frac{V}{1.4}$


## Método Huntington-Hill

Método creado en 1920 por Joseph Hill y corregido por el compañero de escuela de Hill, Edward Huntington. Es un método en el que se elige el tamaño de la cámara.  
El objetivo es mantener la relación de "una persona un voto" lo más cercana posible a 1.

### Método

$\textrm{D} = \frac{Población Total}{NúmeroTotalDiputados}$

Calcular la cuota de diputados por estado:  

$CoutaEstado = \frac{Población Estado}{D}$

Redondeamos la cuota a la parte entera.  

$\textrm{n} = ParteEntera\left\{{Cuota Estado}\right\}$

Comparar la Cuota del estado con la media geométrica de $n$ y $n+1$, $\sqrt{n(n+1)}$

Si $\begin{cases}CuotaEstado>MediaGeométrica & Representantes = n+1\\\textrm{Caso Contrario} & Representantes = n\end{cases}$

Ajustar D para que el número de asientos totales coincida con el número total de asientos designados.

## Cuota Hagenbach-Bischoff

Fórmula utilizada en los sistemas de representación proporcional para un sistema de listas electorales. Su nombre proviene del inventor suizo, profesor de física y matemáticas Eduard Hagenbach-Bischoff (1833–1910). 

### Reparto

La fórmula de reparto es: 

$\textrm{Cociente} = \frac{Total Votos}{Total Escaños+1}$  donde:  

*Total votos*: Representa el número total de votos válidos.  

*Total escaños*: Total de escaños a repartir.  



## Método de Condorcet

El método de Condorcet lleva el nombre del matemático y filósofo francés del siglo XVIII Marie Jean Antoine Nicolas Caritat, marqués de Condorcet, aunque anteriormente Ramón Llull en 1299 creó un método similar que cumple el criterio de Condorcet pero en un diseño iterativo.

Es uno de los métodos en los que se elige al candidato que gana la mayoría de los votos en cada par de elecciones frente a cada uno de los otros candidatos, es decir, un candidato preferido por más votantes que cualquier otro, siempre que exista tal candidato. Un candidato con esta propiedad, el campeón de la pareja o el ganador de la victoria, se llama formalmente el ganador de Condorcet.

Puede que no siempre exista un ganador del premio Condorcet en una elección particular porque la preferencia de un grupo de votantes que seleccionan entre más de dos opciones puede ser cíclica, es decir, es posible (pero muy raro) que cada candidato tenga un oponente que le derrote en una contienda entre dos candidatos. La posibilidad de tales preferencias cíclicas en un grupo de votantes se conoce como la paradoja de Condorcet. 

### Procedimiento

- Voto  
  En una elección según el método de Condorcet el votante rellena la lista de candidatos por orden de preferencia. 

- Vencedor  
  El recuento se realiza contrastando a cada candidato contra todos los demás candidatos en una serie de hipotéticos enfrentamientos uno a uno. El ganador de cada pareja es el candidato preferido por la mayoría de los votantes. Se considera que el candidato preferido por cada votante es el que está más alto en su papeleta de votación. Cuando se han considerado todos los emparejamientos posibles de candidatos, si un candidato vence a todos los demás candidatos en estos concursos, entonces se le declara ganador de Condorcet. Como se ha señalado anteriormente, si no hay un ganador de Condorcet debe utilizarse otro método para encontrar el ganador de la elección, y este mecanismo varía de un método de Condorcet a otro.
  
- Recuento de votos mediante matrices  
  Se utiliza para los resultados una matriz en donde cada fila es el elemento como "contendiente" y en cada columna el elemento como "oponente".
  
  En el caso de que un candidato gane a todos los restantes, será el ganador de Condorcet. Cuando no hay un ganador Condorcet se utilizan métodos alternativos de Condorcet, como el método Minimax y el método Schulze, que utilizan la información contenida en la matriz para elegir un ganador.
  

## Método del resto mayor

Es un método para distribuir los escaños proporcionalmente para un sistema de listas de partidos. Son una alternativa a los métodos de promedio mayor. 

El método del resto mayor requiere que el número de votos de cada partido se divida por una cuota que represente el número de votos necesarios para un escaño (es decir, normalmente el número total de votos emitidos dividido por el número de escaños, o alguna fórmula similar). El resultado para cada partido consistirá normalmente en la parte entera más un resto  A cada partido se le asigna primero un número de escaños igual a su número entero. Esto generalmente dejará algunos escaños sin asignar: los partidos se clasificarán entonces sobre la base de los restos, y a los partidos con los restos más grandes se les asigna cada uno un escaño adicional hasta que se hayan asignado todos los escaños. De ahí el nombre del método.
Hay distintos modelos para calcular el cociente, los más utilizados son el cociente Hare, Droop e Imperiali.

### Cociente Hare

La fórmula del cociente Hare es la fórmula más simple que puede utilizarse en unas elecciones según un sistema de voto transferible único, también se utiliza en sistemas de representación proporcional por listas. En comparación con algunos métodos similares, la utilización del método del cociente de Hare con el método de resto mayor tiende a favorecer a las partes más pequeñas a expensas de las más grandes. 

- Fórmula:

$Cociente = \frac{Total Votos}{Total Escaños}$ 
  
### Cociente Droop

Algunos países que emplean este cociente son Australia Irlanda o Malta, entre otros.
Es más favorable a los partidos mayoritarios que el obtenido mediante el sistema Hare, aunque no favorece tanto como el sistema Imperiali.


Si se eligen ${n}$ escaños para un cuerpo colegiado, y se emiten ${m}$ votos válidos, se establece un cociente ${q}$ el cual utilizaremos para repartir los votos. Este cociente se calcula mediante la fórmula:

${q=1+{\frac {m}{n+1}}}$  con $q$ aproximado al entero más próximo.

Si la i-ésima lista de I listas inscritas obtiene ${m_{i}}$ votos, esta lista tendrá ${e_{i}}$ escaños por cociente y ${r_{i}}$ votos por residuo mediante la fórmula: ${m_{i}=qe_{i}+r_{i}}$

${e_{i}=\left\lfloor {\frac {m_{i}}{q}}\right\rfloor ,r_{i}=m_{i}-qe_{i}}$

Definimos k como el número de escaños restantes no son obtenidos por el cociente:

${k=n-\sum _{i=1}^{I}e_{i}}$

Estos k escaños son repartidos entre los mejores k residuos ${r_{i}}$.

De esta forma, el número total de escaños del i-ésimo partido será ${p_{i}=e_{i}}$ o ${p_{i}=e_{i}+1}$.


### Cociente Imperiali

El reparto es más favorable a los partidos mayoritarios que el que se pueda obtener mediante los métodos de Hare o Droop.

- Reparto

Si se eligen n escaños para un cuerpo colegiado, y se emiten m votos válidos, se establece un cociente q el cual servirá para repartir los votos. Este cociente se calcula mediante la fórmula:

${q={\frac {m}{n+2}}.}$
con q aproximado al entero más próximo.

Si la i-ésima lista de I listas inscritas obtiene ${m_{i}}$ votos, esta lista tendrá ${e_{i}}$ escaños por cociente y ${r_{i}}$ votos por residuo mediante la fórmula: ${m_{i}=qe_{i}+r_{i}}$.

${e_{i}=\left\lfloor {\frac {m_{i}}{q}}\right\rfloor ,r_{i}=m_{i}-qe_{i}}$

## Método Schulze

Método por el cual se selecciona un ganador a partir de las preferencias de los votantes, fue creado en 1997 por Markus Schulze 

- Método

    + Averiguar el conjunto de Schwartz (el menor conjunto de candidatos que no es ganado por nadie fuera del conjunto). Si sólo hay un candidato en el conjunto, este es el ganador de Condorcet. Si hay varios miembros pero no hay derrotas entre ellos, entonces hay un empate normal entre ellos.
    + En cualquier otro caso, eliminar la derrota más suave en el conjunto de Schwartz (es decir, aquella ganada por el menor margen). Recalcular el nuevo conjunto de Schwartz y repetir el proceso.

## Regla de Hamilton

-Rev- El Método de Hamilton es un método que se emplea para repartir los escaños de un Parlamento. Se trata de un método no proporcional, ya que dependiendo de la provincia se necesitará un número diferente de votos para obtener un escaño.

Para conseguir que cada estado recibiera un número de representantes lo más cercano a su cuota, Hamilton asigna a cada estado, en una primera aproximación, la parte entera de su cuota. Luego, los escaños aún no repartidos se reparten por orden de mayor a menor a los que tienen parte decimal más grande.

$\textrm{Cuota} = \frac{Censo Distrito}{Censo Total}$ 



<!-- # Analisis de los datos  -->

<!-- ## Año 1977 -->

<!-- ```{r Leer y limpiar datos, eval=FALSE, include=FALSE} -->
<!-- library(openxlsx) -->
<!-- library(electoral) -->
<!-- setwd("~/Universidad/TFG/TFG_Git") -->
<!-- datos1977 <- read.xlsx(xlsxFile = "Datos/Congreso/PROV_02_197706_1.xlsx") -->
<!-- # Eliminar fila con nombres y sustituirlos por las siglas -->
<!-- datos1977[3, ][!is.na(datos1977[2, ])] <- datos1977[2, ][!is.na(datos1977[2, ])] -->
<!-- datos1977 <- datos1977[-nrow(datos1977), ] -->
<!-- colnames(datos1977) <- datos1977[3, ] -->
<!-- datos1977 <- datos1977[-c(1, 2, 3), ] -->
<!-- # Columnas como números -->
<!-- datos1977[, 4:ncol(datos1977)] <- apply(datos1977[, 4:ncol(datos1977)], 2, as.numeric) -->
<!-- row.names(datos1977) <- NULL -->
<!-- # Quedarnos con las columnas que queramos -->
<!-- datos1977$asientos <- rowSums(datos1977[, (colnames(datos1977) %in% c("Diputados"))]) -->
<!-- datos1977 <- datos1977[, !(colnames(datos1977) %in% c("Diputados"))] -->
<!-- datos1977 <- datos1977[, -grep(pattern = c("censo"), tolower(colnames(datos1977)))] -->
<!-- datos1977 <- datos1977[, -grep(pattern = c("Código"), colnames(datos1977))] -->

<!-- datos1977 <- datos1977[, -grep(pattern = c("mesas"), colnames(datos1977))] -->
<!-- ``` -->


<!-- ### Método D`Hondt -->

<!-- Calculamos el número de escaños obtenidos por los diferentes partidos según el método particular de votación en España, en donde si los partidos no llegan a un 3% de representación, no tendrán representabilidad. -->



<!-- ```{r eval=FALSE, include=FALSE} -->

<!-- library(data.table) -->
<!-- borrar <- NULL -->
<!-- for (prov in seq_len(nrow(datos1977))) { -->
<!--   # Votos tenerife Alianza Popular mal contados -->
<!--   if (prov == 15) { -->
<!--     datos1977[prov, 12] <- 23866 -->
<!--   } -->
<!--   # Contar a partir de columna de los partidos -->
<!--   desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977)) -->
<!--   # Cota del 3% -->
<!--   corte <- 100 * colSums(datos1977[prov, desde:ncol(datos1977)]) / sum(datos1977$`Votos válidos`[prov]) -->
<!--   partidos <- colnames(datos1977[, desde:ncol(datos1977)])[corte > 3] -->
<!--   votos <- datos1977[prov, desde:ncol(datos1977)][corte > 3] -->
<!--   # Asientos por circunscripción -->
<!--   n_asientos <- datos1977$asientos[prov] -->
<!--   s <- 1:n_asientos -->
<!--   # Creamos matriz con los datos y los dividimos -->
<!--   selec <- matrix(data = as.numeric(votos), ncol = length(votos), nrow = n_asientos, byrow = T) -->
<!--   selec <- as.data.frame(selec) -->
<!--   for (i in 1:n_asientos) { -->
<!--     selec[i, ] <- selec[i, ] / i -->
<!--   } -->
<!--   # Arreglamos los nombres y los ordenamos de mayor a menor -->
<!--   colnames(selec) <- partidos -->
<!--   selec <- as.data.frame(selec) -->
<!--   selec <- sort(unlist(selec), decreasing = T)[1:n_asientos] -->
<!--   library(stringr) -->
<!--   names(selec) <- gsub("\\d", "", names(selec))  -->
<!--   # Presentamos el resultado -->
<!--   borrar[[prov]] <- sort(table(names(selec)), decreasing = T) -->
<!-- } -->

<!-- # seats_ha(parties = partidos,votes = as.numeric(votos),n_seats = n_asientos,method = "dhondt") -->
<!-- borrar2 <- borrar[[1]] -->
<!-- for (i in 2:length(borrar)) { -->
<!--   borrar2 <- c(borrar2, borrar[[i]]) -->
<!-- } -->
<!-- resul_dhondt_1977 <- as.data.table(aggregate(as.numeric(borrar2), by = list(names(borrar2)), FUN = sum))[order(-x)] -->
<!-- ``` -->

<!-- ### Método Sainte-Lague -->

<!-- ```{r eval=FALSE, include=FALSE} -->

<!-- borrar <- NULL -->
<!-- for (prov in seq_len(nrow(datos1977))) { -->
<!--   # Votos tenerife Alianza Popular mal contados -->
<!--   if (prov == 15) { -->
<!--     datos1977[prov, 12] <- 23866 -->
<!--   } -->
<!--   # Contar a partir de columna de los partidos -->
<!--   desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977)) -->
<!--   # Cota del 3% -->
<!--   corte <- 100 * colSums(datos1977[prov, desde:ncol(datos1977)]) / sum(datos1977$`Votos válidos`[prov]) -->
<!--   partidos <- colnames(datos1977[, desde:ncol(datos1977)])[corte > 3] -->
<!--   votos <- datos1977[prov, desde:ncol(datos1977)][corte > 3] -->
<!--   # Asientos por circunscripción -->
<!--   n_asientos <- datos1977$asientos[prov] -->
<!--   s <- 1:n_asientos -->
<!--   # Creamos matriz con los datos y los dividimos -->
<!--   selec <- matrix(data = as.numeric(votos), ncol = length(votos), nrow = n_asientos, byrow = T) -->
<!--   selec <- as.data.frame(selec) -->
<!--   for (i in 1:n_asientos) { -->
<!--     selec[i, ] <- selec[i, ] / (2 * i + 1) -->
<!--   } -->
<!--   # Arreglamos los nombres y los ordenamos de mayor a menor -->
<!--   colnames(selec) <- partidos -->
<!--   selec <- as.data.frame(selec) -->
<!--   selec <- sort(unlist(selec), decreasing = T)[1:n_asientos] -->
<!--   library(stringr) -->
<!--   names(selec) <- gsub("\\d", "", names(selec)) -->
<!--   # Presentamos el resultado -->
<!--   borrar[[prov]] <- sort(table(names(selec)), decreasing = T) -->
<!-- } -->

<!-- borrar2 <- borrar[[1]] -->
<!-- for (i in 2:length(borrar)) { -->
<!--   borrar2 <- c(borrar2, borrar[[i]]) -->
<!-- } -->
<!-- resul_SainteLague_1977 <- as.data.table(aggregate(as.numeric(borrar2), by = list(names(borrar2)), FUN = sum))[order(-x)] -->
<!-- ``` -->



# Análisis empírico método reparto de escaños

## Según nº partidos, densidad y nº de escaños a repartir

Vamos a simular distintos escenarios para analizarlos según los distintos métodos de reparto de escaños. 

Los sistemas que analizaremos en este análisis emprírico serán, dentro de los métodos de promedio mayor, el método D´Hondt, Método Saint-Lague y el método de Saint-Lague modificado. Dentro de los métodos de resto mayor analizaremos el método Hagenbach-Bischoff, Droop, Hare e Imperiali. Dentro de los métodos mayoritario analizaremos únicamente el método de mayoría simple.

Generaremos datos ficticios de partidos, que irán desde 2 posibles partidos hasta 100 partidos, número de escaños que irán desde 1 posible escaño a repartir a 400 escaños a repartir y según diferentes densidades desde una máxima desigualdad en votos entre los partidos hasta una máxima igualdad de votos entre partidos.



```{r}

library(ggplot2)

n_partidos <- seq_len(50)[-1]

densidad <- rep(length(n_partidos), 100)

n_escannos <- seq_len(50)
```


### D`Hondt
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 1:n_escannos
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### D`Hondt variando el número de escaños

```{r}
# D`Hondt Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   # n_escannos <- i # Variable
#   # votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, i, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### D`Hondt Disproporcionalidad -->

```{r}
disproporcionalidad <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


# disproporcionalidad(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:500], MARGIN = 2, FUN = function(x) disproporcionalidad(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_esc_dhondt <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Disproporcionalidad según D`Hondt", caption = "Angel Gonzalez", x = "Número de Escaños")
```

En este caso se nos presenta la disproporcionalidad variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la disproporcionalidad en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la disproporcionalidad va bajando.
La diferencia de disproporcionalidad en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de disproporcionalidad entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la disproporcionalidad tiende a estabilizarse.

#### D`Hondt variando el número de partidos

```{r}
# D`Hondt Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- disproporcionalidad(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_par_dhondt <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Disproporcionalidad según D`Hondt", caption = "Angel Gonzalez", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 o 3 partidos a las elecciones la disproporcionalidad es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de disproporcionalidad con 6 partidos que se presentan a las elecciones, a partir de el séptimo partido la curva comienza a decrecer.
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 4 a 60 ) la disproporcionalidad es alta pero decreciente, cuanto mayor número de partidos se presentan en las elcciones menor es la disproporcionalidad que encontramos, como en el apartado anterior, la disproporcionalidad tiende a estabilizarse.



#### D`Hondt variando la distribución de los votos

```{r}
# D`Hondt Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- disproporcionalidad(s = resul1[[i]], v = vot[[i]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Disproporcionalidad",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_dis_dhondt <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Disproporcionalidad según D`Hondt", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.
Observando el gráfico observamos que cuando la concentración del voto es muy baja la disproporcionalidad está en un nivel bajo, cuanto más concentración de voto podemos comprobar como la disproporcionalidad aumenta hasta que alcanza un punto en donde alcanza el máximo de disproporcionalidad y a partir de ese punto la disproporcionalidad va bajando.
Así podemos concluir que el reparto de escaños según la ley D`Hondt es mejor cuanto más concentración de voto tengan unos pocos partidos con respecto a los demás.





### Sainte-Lague
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 2 * (1:n_escannos) - 1
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Sainte-Lague variando el número de escaños

```{r}
# Sainte-Lague Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Sainte-Lague Disproporcionalidad -->
  
```{r}
disproporcionalidad <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#disproporcionalidad(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:500], MARGIN = 2, FUN = function(x) disproporcionalidad(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_esc_sl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Disproporcionalidad según Sainte-Lague", caption = "Angel Gonzalez", x = "Número de Escaños")
```

En este caso se nos presenta la disproporcionalidad variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la disproporcionalidad en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la disproporcionalidad va bajando.
La diferencia de disproporcionalidad en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de disproporcionalidad entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la disproporcionalidad tiende a estabilizarse.

#### Sainte-Lague variando el número de partidos

```{r}
# Sainte-Lague Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- disproporcionalidad(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_par_sl <- dis1


ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Disproporcionalidad según Sainte-Lague", caption = "Angel Gonzalez", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 partidos a las elecciones la disproporcionalidad es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de disproporcionalidad con 2 partidos que se presentan a las elecciones, a partir de el séptimo partido la curva comienza a decrecer.
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 4 a 6 ) la disproporcionalidad es alta pero decreciente, cuanto mayor número de partidos se presentan en las elcciones menor es la disproporcionalidad que encontramos, como en el apartado anterior, la disproporcionalidad tiende a estabilizarse.



#### Sainte-Lague variando la distribución de los votos

```{r}
# Sainte-Lague Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- disproporcionalidad(s = resul1[[i]], v = vot[[i]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Disproporcionalidad",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_dis_sl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Disproporcionalidad según Sainte-Lague", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.
Observando el gráfico observamos que cuando la concentración del voto es muy baja la disproporcionalidad está en un nivel alto, aumenta levemente para una concentración baja-media y a partir de ahí, donde alcanza el máximo de disproporcionalidad, la curva va decreciendo cuanto mas diferencia de votos entre partidos exista.
Así podemos concluir que el reparto de escaños según la ley Sainte-Lague es mejor cuanto más concentración de voto tengan unos pocos partidos con respecto a los demás.


### Modified Sainte-Lague
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- c(1, (10 * (2:n_escannos) - 5) / 7)
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Modified Sainte-Lague variando el número de escaños

```{r}
# Modified Sainte-Lague Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Modified Sainte-Lague Disproporcionalidad -->
  
```{r}
disproporcionalidad <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#disproporcionalidad(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:500], MARGIN = 2, FUN = function(x) disproporcionalidad(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_esc_msl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Disproporcionalidad según Modified Sainte-Lague", caption = "Angel Gonzalez", x = "Número de Escaños")
```

En este caso se nos presenta la disproporcionalidad variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la disproporcionalidad en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la disproporcionalidad va bajando.
La diferencia de disproporcionalidad en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de disproporcionalidad entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la disproporcionalidad tiende a estabilizarse.

#### Modified Sainte-Lague variando el número de partidos

```{r}
# Modified Sainte-Lague Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- disproporcionalidad(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_par_msl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Disproporcionalidad según Modified Sainte-Lague", caption = "Angel Gonzalez", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 o 3 partidos a las elecciones la disproporcionalidad es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de disproporcionalidad con 6 partidos que se presentan a las elecciones, a partir de el séptimo partido la curva comienza a decrecer.
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 2 a 6 ) la disproporcionalidad es alta pero decreciente, cuanto mayor número de partidos se presentan en las elcciones menor es la disproporcionalidad que encontramos, como en el apartado anterior, la disproporcionalidad tiende a estabilizarse.



#### Modified Sainte-Lague variando la distribución de los votos

```{r}
# Modified Sainte-Lague Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- disproporcionalidad(s = resul1[[i]], v = vot[[i]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Disproporcionalidad",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_dis_msl <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Disproporcionalidad según Modified Sainte-Lague", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.
Observando el gráfico observamos que cuando la concentración del voto es muy baja la disproporcionalidad está en un nivel medio, cuanto más concentración de voto podemos comprobar como la disproporcionalidad aumenta hasta que alcanza un punto en donde alcanza el máximo de disproporcionalidad y a partir de ese punto la disproporcionalidad va bajando.
Así podemos concluir que el reparto de escaños según la ley Modified Sainte-Lague es mejor cuanto más concentración de voto tengan unos pocos partidos con respecto a los demás.


### Imperiali
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- ((1:n_escannos) + 1) / 2
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Imperiali variando el número de escaños

```{r}
# Imperiali Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Imperiali Disproporcionalidad -->
  
```{r}
disproporcionalidad <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#disproporcionalidad(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:500], MARGIN = 2, FUN = function(x) disproporcionalidad(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_esc_imp <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Disproporcionalidad según Imperiali", caption = "Angel Gonzalez", x = "Número de Escaños")
```

En este caso se nos presenta la disproporcionalidad variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la disproporcionalidad en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la disproporcionalidad va bajando.
La diferencia de disproporcionalidad en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de disproporcionalidad entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la disproporcionalidad tiende a estabilizarse.

#### Imperiali variando el número de partidos

```{r}
# Imperiali Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- disproporcionalidad(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_par_imp <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Disproporcionalidad según Imperiali", caption = "Angel Gonzalez", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 o 3 partidos a las elecciones la disproporcionalidad es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de disproporcionalidad con 6 partidos que se presentan a las elecciones, a partir del séptimo partido la curva comienza a decrecer.
Entonces, según el modelo Imperiali tendremos una menor disproporcionalidad según se vayan aumentando el número de partidos.



#### Imperiali variando la distribución de los votos

```{r}
# Imperiali Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- disproporcionalidad(s = resul1[[i]], v = vot[[i]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Disproporcionalidad",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_dis_imp <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Disproporcionalidad según Imperiali", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.
Observando el gráfico observamos que cuando la concentración del voto es muy baja la disproporcionalidad está en un nivel bajo, cuanto más concentración de voto podemos comprobar como la disproporcionalidad aumenta hasta que alcanza un punto en donde alcanza el máximo de disproporcionalidad y a partir de ese punto la disproporcionalidad va bajando.
Así podemos concluir que el reparto de escaños según la ley Imperiali obtiene su menor disproporcionalidad en los escenarios en donde la diferencia de votos entre los partidos sea muy baja.


### Huntington-Hill
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- sqrt((1:n_escannos) * ((1:n_escannos) - 1))
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Huntington-Hill variando el número de escaños

```{r}
# Huntington-Hill Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Huntington-Hill Disproporcionalidad -->
  
```{r}
disproporcionalidad <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#disproporcionalidad(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:500], MARGIN = 2, FUN = function(x) disproporcionalidad(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_esc_hh <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Disproporcionalidad según Huntington-Hill", caption = "Angel Gonzalez", x = "Número de Escaños")
```

En este caso se nos presenta la disproporcionalidad variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la disproporcionalidad en el caso de un escaño es muy alta,es interesante observar que para un número de escaños entre 1 y 50 la disproporcionalidad no cambia, es a partir de los 50 escaños y posteriores donde observamos el descenso de la disproporcionalidad, descenso rápido en los primeros escaños que tiende a estabilizarse cuanto mayor número de escaños se repartan.


#### Huntington-Hill variando el número de partidos

```{r}
# Huntington-Hill Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- disproporcionalidad(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_par_hh <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Disproporcionalidad según Huntington-Hill", caption = "Angel Gonzalez", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.

Observamos que cuando se presentan 2 o 3 partidos a las elecciones la disproporcionalidad es media, va aumentando a medida que se presentan más partidos, alcanzando el máximo de disproporcionalidad con 50 partidos que se presentan a las elecciones, a partir de 50 partidos la curva comienza a decrecer.

Lo particular de este método respecto a otros métodos es que la menor disproporcionalidad no se obtiene en el caso de que se presenten a las elecciones pocos partidos, sino que la menor disproporcionalidad se obtiene cuanto más partidos se presenten a las elecciones.


#### Huntington-Hill variando la distribución de los votos

```{r}
# Huntington-Hill Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- disproporcionalidad(s = resul1[[i]], v = vot[[i]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Disproporcionalidad",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_dis_hh <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Disproporcionalidad según Huntington-Hill", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.

Observando el gráfico observamos que cuando la concentración del voto es muy baja la disproporcionalidad está en un nivel bajo, disproporcionalidad que se mantiene baja cuando la concentración de los votos es baja, y que a partir de una concentración de votos medio-baja la disproporcionalidad va aumentando cuanto más diferencia de votos entre partidos se presenten.

Así podemos concluir que el reparto de escaños según la ley Huntington-Hill es mejor cuanto menor concentración de voto tengan los partidos entre ellos, presenta un comportamiento diferente respecto a los otros métodos en donde cuanto mayor concentración de votos menor disproporcionalidad.


### Adams
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 1:n_escannos - 1
  div[is.na(div)] <- 0
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Adams variando el número de escaños

```{r}
# Adams Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Adams Disproporcionalidad -->

```{r}
disproporcionalidad <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#disproporcionalidad(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:500], MARGIN = 2, FUN = function(x) disproporcionalidad(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_esc_ad <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Disproporcionalidad según Adams", caption = "Angel Gonzalez", x = "Número de Escaños")
```

En este caso se nos presenta la disproporcionalidad variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la disproporcionalidad en el caso de un escaño es muy alta, en este método también observamos que la disproporcionalidad se mantiene en un mismo nivel hasta los 50 escaños, posteriormente cuanto mayor es el número de escaños a repartir la disproporcionalidad va bajando.
La diferencia de disproporcionalidad en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de disproporcionalidad entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la disproporcionalidad tiende a estabilizarse.

#### Adams variando el número de partidos

```{r}
# Adams Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- disproporcionalidad(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_par_ad <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Disproporcionalidad según Adams", caption = "Angel Gonzalez", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.

Observamos que cuando se presentan 2 o 3 partidos a las elecciones la disproporcionalidad es media, va aumentando a medida que se presentan más partidos, alcanzando el máximo de disproporcionalidad con 50 partidos que se presentan a las elecciones, a partir de los 50 partidos que se presentan a las elecciones la curva comienza a decrecer.

Entonces según el método Adams obtenemos el mejor resultado cuanto mayor número de partidos  se presenten a las elecciones.


#### Adams variando la distribución de los votos

```{r}
# Adams Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- disproporcionalidad(s = resul1[[i]], v = vot[[i]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Disproporcionalidad",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_dis_ad <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Disproporcionalidad según Adams", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.

Observando el gráfico observamos que cuando la concentración del voto es muy baja la disproporcionalidad está en un nivel bajo, cuanto más concentración de voto podemos comprobar como la disproporcionalidad va aumentando cada vez con una diferencia decreciente.

Así podemos concluir que el reparto de escaños según la ley Adams es mejor cuanto menor concentración de voto los partidos entre ellos, y será peor cuanto mayor concentración de voto se presente.

### Danish
```{r}
library(data.table)
# Variables
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5
votos <- trunc(seq(from = 100, to = 1, length.out = length(partidos)))

asientos_dhondt <- function(partidos, votos,
                            n_escannos,
                            couta_min = 0) {
  # Cuota mínima
  nv <- sum(votos)
  vn <- votos
  vn[votos <= nv * couta_min] <- 0
  votos <- vn

  # Escaños
  div <- 3 * (1:n_escannos) - 2
  G <- sapply(div, function(x) votos / x)
  cuota <- G[order(G, decreasing = T)][n_escannos]
  W <- (G >= cuota)
  seats <- rowSums(W)
  o <- seats
  # Resultados
  data.frame("Partidos" = partidos, "Escanos" = as.numeric(o))
}

# Modelo para España
# desde <- 1 + grep(pattern = "nulos", x = colnames(datos1977))
# partidos <- colnames(datos1977)[desde:(length(colnames(datos1977)) - 1)]
# prov <- 1
# n_escannos <- datos1977$asientos[prov]
# votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#
# asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
####


#
# resul <- NULL
# for (prov in seq_len(nrow(datos1977))) {
#   # Votos tenerife Alianza Popular mal contados
#   if (prov == 15) {
#     datos1977[prov, 12] <- 23866
#   }
#   n_escannos <- datos1977$asientos[prov]
#   votos <- as.numeric(datos1977[prov, desde:(ncol(datos1977) - 1)])
#   resul[[prov]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = .03)
# }
#
# resul <- as.data.table(resul)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

#### Danish variando el número de escaños

```{r}
# Danish Prueba fijo densidad, fijo votos, fijo n_partidos, distintos escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 5000
votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
votos <- votos / seq_len(49)

# resul <- NULL
# for (i in seq_len(n_escannos)) {
#   n_escannos <- i # Variable
#   votos <- votos # Fijo
#   resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
# }
resul <- lapply(seq_len(n_escannos), function(x) asientos_dhondt(partidos, votos, x, couta_min = 0)$Escanos)
resul1 <- as.data.table(resul)
# beepr::beep(sound = 3)
# resultados <- cbind.data.frame("Partidos" = resul[, 1], "Escaños" = rowSums(resul[, lapply(resul, is.numeric) == TRUE, with = FALSE]))
```

<!-- #### Danish Disproporcionalidad -->
  
```{r}
disproporcionalidad <-
  function(s, v) {
    s <- as.vector(s)
    v <- as.vector(v)
    l_s <- length(s)
    #        l_v <- length(v)
    s_s <- sum(s)
    s_v <- sum(v)
    p_s <- s / s_s
    p_v <- v / s_v

    o <- (1 / l_s) * sum(abs(p_s - p_v))
    #            nm <- 'Rae'

    # return(list(measure=nm, value=o))
    o
  }


#disproporcionalidad(s = resul1[, 1], v = votos)

dis <- apply(X = resul1[, 1:500], MARGIN = 2, FUN = function(x) disproporcionalidad(s = x, v = votos))

library(ggplot2)
library(ggthemes)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_esc_dan <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de escaños a repartir", title = "Disproporcionalidad según Danish", caption = "Angel Gonzalez", x = "Número de Escaños")
```

En este caso se nos presenta la disproporcionalidad variando el número de de escaños posibles, en el presente caso se empieza por repartir un único escaño hasta los 500 posibles escaños.
Observamos que la disproporcionalidad en el caso de un escaño es muy alta, posteriormente cuanto mayor es el número de escaños a repartir la disproporcionalidad va bajando.
La diferencia de disproporcionalidad en los casos en los que hay pocos escaños a repartir es alta, cuantos mas escaños a repartir la diferencia de disproporcionalidad entre sucesivos escaños va reduciendose, a números altos de escaños a repartir la disproporcionalidad tiende a estabilizarse.

#### Danish variando el número de partidos

```{r}
# Danish Prueba fijo densidad, fijo votos, var n_partidos, fijo escaños
partidos <- NULL
for (i in seq_len(500)) {
  partidos[[i]] <- paste("Partido_", seq_len(i), sep = "")
}
# partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 30
votos <- NULL
for (i in seq_len(500)) {
  votos[[i]] <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos[[i]])))
  votos[[i]] <- votos[[i]] / seq_len(length(partidos[[i]]))
}
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))
# votos <- votos/seq_len(length(partidos))

resul <- NULL
for (i in seq_len(length(partidos))) {
  if (i == 1) {
    next
  }
  n_escannos <- 50 # Variable
  # votos <- votos[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos[[i]], votos[[i]], n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)
# Arreglar tabla poniendo NA donde se necesita
for (i in 3:(ncol(resul1) - 2)) {
  resul1[[i - 2]][i:nrow(resul1)] <- NA
}

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(length(partidos))
for (i in seq_len(length(partidos) - 1)) {
  dis[i] <- disproporcionalidad(s = as.vector(na.omit(resul1[[i]])), v = votos[[i + 1]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))
dis[500] <- 0


library(ggplot2)
# qplot(seq_len(length(dis)),dis)

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_par_dan <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando el número de partidos", title = "Disproporcionalidad según Danish", caption = "Angel Gonzalez", x = "Número de Partidos")
```

En el caso presente únicamente modificamos el número de partidos presentes en la elección, desde un único posible partido hasta 500 partidos que se presentan a una elección ficticia.
Observamos que cuando se presentan 2 o 3 partidos a las elecciones la disproporcionalidad es baja, va aumentando a medida que se presentan más partidos, alcanzando el máximo de disproporcionalidad con 6 partidos que se presentan a las elecciones, a partir de el séptimo partido la curva comienza a decrecer.
Podemos apreciar en el gráfico que para un número bajo de partidos que se presentan a las elecciones ( de 4 a 6 ) la disproporcionalidad es alta pero decreciente, cuanto mayor número de partidos se presentan en las elecciones menor es la disproporcionalidad que encontramos, como en el apartado anterior, la disproporcionalidad tiende a estabilizarse.

Entonces según el método Danish obtenemos el mejor resultado cuanto más partidos se presenten a las elecciones.



#### Danish variando la distribución de los votos

```{r}
# Danish Prueba var densidad, fijo votos, fijo n_partidos, fijo escaños
partidos <- paste("Partido_", seq_len(49), sep = "")
n_escannos <- 500
# votos <- trunc(seq(from = 10e5, to = 1, length.out = length(partidos)))

# Modificar la densidad de los votos
votos <- trunc(rep(x = 10e5, length(partidos)))
expon <- seq(from = 0.001, to = 1, length.out = 1000)
vot <- NULL
for (i in seq_len(1000)) {
  vot[[i]] <- votos * dexp(seq_len(length(partidos)), rate = expon[i])
}



# ut <- (datos1977[1:nrow(datos1977),9:ncol(datos1977)])
# ut <- as.matrix(ut)
# lm(1:ncol(ut)~sort(ut[1,],decreasing = T))




# Aplicarlo
resul <- NULL
for (i in seq_len(n_escannos)) {
  # n_escannos <- i # Variable
  votos <- vot[[i]] # Fijo
  resul[[i]] <- asientos_dhondt(partidos, votos, n_escannos, couta_min = 0)$Escanos
}

resul1 <- as.data.table(resul)

# Analizar la desproporcionalidad columna a columna
dis <- seq_len(ncol(resul1))
for (i in seq_len(ncol(resul1))) {
  dis[i] <- disproporcionalidad(s = resul1[[i]], v = vot[[i]])
}
# disproporcionalidad(s = resul1[,1],v = votos)

# dis <- apply(X = resul1,MARGIN = 2,FUN = function(x) disproporcionalidad(s = x,v = votos))



library(ggplot2)
# qplot(seq_len(length(dis)),dis,main = "Prueba",ylab = "Disproporcionalidad",xlab = "
#       Concentración (menor a mayor)")

dis1 <- data.frame("Disproporcionalidad" = dis, "Escannos" = seq_len(length(dis)))
var_dis_dan <- dis1

ggplot(data = dis1, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(data = dis1, mapping = aes(color = Disproporcionalidad), show.legend = F) +
  scale_fill_gradient(low = "red", high = "yellow") +
  labs(subtitle = "Variando la distribución de los votos", title = "Disproporcionalidad según Danish", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")
```

En el presente gráfico variamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande.

Observando el gráfico observamos que cuando la concentración del voto es muy baja la disproporcionalidad está en un nivel medio, cuanto más concentración de voto podemos comprobar como la disproporcionalidad aumenta hasta que alcanza un punto en donde alcanza el máximo de disproporcionalidad y a partir de ese punto la disproporcionalidad va bajando.

Así podemos concluir que el reparto de escaños según la ley Danish es mejor cuanto más concentración de voto tengan unos pocos partidos con respecto a los demás.

## Comparaciones entre métodos

### Variando el número de escaños
```{r}
var_esc_dhondt$Metodo <- "D`Hondt"
var_esc_sl$Metodo <- "Sainte-Lague"
var_esc_msl$Metodo <- "Modified Sainte-Lague"
var_esc_imp$Metodo <- "Imperiali"
var_esc_hh$Metodo <- "Huntington-Hill"
var_esc_ad$Metodo <- "Adams"
var_esc_dan$Metodo <- "Danish"

var_esc <- rbind(var_esc_dhondt, var_esc_sl, var_esc_msl, var_esc_imp, var_esc_hh, var_esc_ad, var_esc_dan)

# ggplot(data = var_esc, mapping = aes(Escannos, Disproporcionalidad)) +
#   # geom_point(data = var_esc, mapping = aes(fill = "Metodo"), show.legend = F) +
#   geom_point() +
#   facet_grid(cols = vars(Metodo)) +
#   scale_fill_gradient(low = "red", high = "yellow") +
#   labs(subtitle = "Variando la distribución de los votos", title = "Disproporcionalidad según Danish", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")

ggplot(data = var_esc, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(aes(colour = factor(Metodo)))+
  labs(subtitle = "Variando el número de escaños a repartir", title = "Disproporcionalidad ", caption = "Angel Gonzalez", x = "Número de Escaños")+
  # labs(title = "Variando la distribución de los votos", subtitle = "Disproporcionalidad", caption = "Angel Gonzalez", x = "Número de Escaños")+
  guides(color=guide_legend(title="Método"))+
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )

```

En el presente gráfico comparamos en un mismo lugar los métodos anteriormente analizados individualmente.
En esta comparación podemos observar que para todos los métodos la disproporcionalidad baja cuanto mayor número de escaños a repartir, los peores métodos en este caso serían el Adams y el Imperiali, el método Adams cuando tengamos un número de escaños menor y el Imperiali a partir aproximadamente de los 100 escaños.
Los mejores métodos en este caso serían el método de Sainte-Lague y el método Danish.


```{r}
var_esc_dhondt$Metodo <- "D`Hondt"
var_esc_sl$Metodo <- "Sainte-Lague"
var_esc_msl$Metodo <- "Modified Sainte-Lague"
var_esc_imp$Metodo <- "Imperiali"
var_esc_hh$Metodo <- "Huntington-Hill"
var_esc_ad$Metodo <- "Adams"
var_esc_dan$Metodo <- "Danish"

var_esc <- rbind(var_esc_dhondt, var_esc_sl, var_esc_msl, var_esc_imp, var_esc_hh, var_esc_ad, var_esc_dan)

# ggplot(data = var_esc, mapping = aes(Escannos, Disproporcionalidad)) +
#   # geom_point(data = var_esc, mapping = aes(fill = "Metodo"), show.legend = F) +
#   geom_point() +
#   facet_grid(cols = vars(Metodo)) +
#   scale_fill_gradient(low = "red", high = "yellow") +
#   labs(subtitle = "Variando la distribución de los votos", title = "Disproporcionalidad según Danish", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")

ggplot(data = var_esc[var_esc$Escannos>300&var_esc$Escannos<400,], mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(aes(colour = factor(Metodo)))+
  labs(subtitle = "Variando el número de escaños a repartir", title = "Disproporcionalidad ", caption = "Angel Gonzalez", x = "Número de Escaños")+guides(color=guide_legend(title="Método"))+
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )

```

En este gráfico nos centramos en la disproporcionalidad para un número de escaños a repartir de entre 300 y 400 diputados, actualmente en España se reparten 350 diputados.
El peor método entre los presentados es el método Imperiali, con una diferencia significatica respecto a los demás métodos. Los mejores métodos de reparto podemos agruparlos en un grupo de tres, que son el método de Sainte-Lague en primer lugar, el método Modified Sainte-Lague y el método Danish respectivamente.
Podemos agrupar los métodos en tres grupos,un grupo que sería el de una disproporcionalidad baja, en el que se encontrarían los métodos de Sainte-Lague, Danish y Modified Sainte-Lague.
Un segundo grupo que sería el que presentaría una disproporcionalidad media, con los métodos Adams, Huntington-Hill y D´Hondt, finalizando con un último grupo de disproporcionalidad alta, y debido a ello no deseable en el que estaría el método Imperiali.

Actualmente en España se reparten 350 escaños y se utiliza el método D´Hondt, según los datos obtenidos podemos decir que no es el mejor método que se puede utilizar, es un método que está en el grupo de dispropocionalidad media, e incluso no es el mejor método dentro de ese subgrupo, sería interesante según lo observado en la gráfica plantearse un cambio de método a otro mejor, al menos a alguno dentro del subgrupo de disproporcionalidad baja, preferentemente el mejor método que podríamos utilizar, que sería el método de Sainte-Lague sin modificar.

### Variando el número de partidos
```{r}
var_par_dhondt$Metodo <- "D`Hondt"
var_par_sl$Metodo <- "Sainte-Lague"
var_par_msl$Metodo <- "Modified Sainte-Lague"
var_par_imp$Metodo <- "Imperiali"
var_par_hh$Metodo <- "Huntington-Hill"
var_par_ad$Metodo <- "Adams"
var_par_dan$Metodo <- "Danish"

var_par <- rbind(var_par_dhondt, var_par_sl, var_par_msl, var_par_imp, var_par_hh, var_par_ad, var_par_dan)


  ggplot(data = var_par, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(aes(colour = factor(Metodo)))+
  labs(subtitle = "Variando el número de partidos", title = "Disproporcionalidad", caption = "Angel Gonzalez", x = "Número de partidos") + guides(color=guide_legend(title="Método")) +
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )
```

En el presente gráfico comparamos la disproporcionalidad variando el número de partidos en un mismo lugar con los métodos anteriormente analizados individualmente.

Observamos que para un número de partidos bajo hasta los 50 partidos que se presentan a unas elecciones la disproporcionalidad es muy variable, a partir de los 50 partidos se estabiliza y podemos sacar algunas conclusiones, en primer lugar el peor método claramente en este caso es el método Adams, mientras que los demás métodos son muy similares en su disproporcionalidad, donde la menor disproporcionalidad lo podemos encontrar en el método Adams.


```{r}
var_par_dhondt$Metodo <- "D`Hondt"
var_par_sl$Metodo <- "Sainte-Lague"
var_par_msl$Metodo <- "Modified Sainte-Lague"
var_par_imp$Metodo <- "Imperiali"
var_par_hh$Metodo <- "Huntington-Hill"
var_par_ad$Metodo <- "Adams"
var_par_dan$Metodo <- "Danish"

var_par <- rbind(var_par_dhondt, var_par_sl, var_par_msl, var_par_imp, var_par_hh, var_par_ad, var_par_dan)


  ggplot(data = var_par[var_par$Escannos<50,], mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(aes(colour = factor(Metodo)))+geom_line(aes(colour = factor(Metodo)),size=1)+
  labs(subtitle = "Variando el número de partidos", title = "Disproporcionalidad", caption = "Angel Gonzalez", x = "Número de partidos") + guides(color=guide_legend(title="Método")) +
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )
```

En este gráfico nos centramos en la disproporcionalidad para un número de partidos entre 2 y 50 partidos.

Observamos que hasta los 20 partidos que se presentan a las elecciones la disproporcionalidad es muy variable entre ellos, a partir de los 20 partidos que se presentan en las elecciones podemos extraer algunas conclusiones, se ven dos grupor direfenciados, un grupo en donde la disproporcionalidad es estable e incluso decreciente  y otro grupo en el que la disproporcionalidad va aumentando, que son los métodos de Adams y Huntington-Hill.

En España se utiliza el método D´Hondt, según los datos obtenidos podemos concluir que el método d´Hondt no es el mejor método entre los analizados, sería el cuarto mejor método entre siete métodos posibles, es decir, sería deseable para obtener una mayor proporcionalidad que se cambiase el método de reparto a otro mejor, en este caso observamos que el mejor método es el Saint-Lague.

### Variando la distribución de los votos
```{r}
var_dis_dhondt$Metodo <- "D`Hondt"
var_dis_sl$Metodo <- "Sainte-Lague"
var_dis_msl$Metodo <- "Modified Sainte-Lague"
var_dis_imp$Metodo <- "Imperiali"
var_dis_hh$Metodo <- "Huntington-Hill"
var_dis_ad$Metodo <- "Adams"
var_dis_dan$Metodo <- "Danish"

var_dis <- rbind(var_dis_dhondt, var_dis_sl, var_dis_msl, var_dis_imp, var_dis_hh, var_dis_ad, var_dis_dan)


  ggplot(data = var_dis, mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(aes(colour = factor(Metodo)))+
  labs(subtitle = "Variando la distribucion de los votos", title = "Disproporcionalidad", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")+guides(color=guide_legend(title="Método"))+
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )
```

En el presente gráfico comparamos la distribución de los votos en unas elecciones ficticias, comenzamos con una concentración de votos baja, es decir, la diferencia de votos entre partidos es baja, hasta acabar con una concentración de votos alta, en donde la diferencia de votos entre partidos es muy grande. Todo ello en un mismo lugar con los métodos anteriormente analizados individualmente.

Observamos que hay dos grupos diferenciados, uno de ellos en los que la disproporcionalidad es baja para una menor concentración de votos entre los partidos y que a medida que la concentración aumenta también va aumentando la disproporcionalidad, donde se encuentran los métodos de Adams y Huntington-Hill. El otro grupo se caracteriza por en cuanto la concentración del voto es muy baja la disproporcionalidad está en un nivel bajo, cuanto más concentración de voto podemos comprobar como la disproporcionalidad aumenta hasta que alcanza un punto en donde alcanza el máximo de disproporcionalidad y a partir de ese punto la disproporcionalidad va bajando alcanzando el mínimo de disproporcionalidad.

```{r}
var_dis_dhondt$Metodo <- "D`Hondt"
var_dis_sl$Metodo <- "Sainte-Lague"
var_dis_msl$Metodo <- "Modified Sainte-Lague"
var_dis_imp$Metodo <- "Imperiali"
var_dis_hh$Metodo <- "Huntington-Hill"
var_dis_ad$Metodo <- "Adams"
var_dis_dan$Metodo <- "Danish"

var_dis <- rbind(var_dis_dhondt, var_dis_sl, var_dis_msl, var_dis_imp, var_dis_hh, var_dis_ad, var_dis_dan)


  ggplot(data = var_dis[var_dis$Escannos>400,], mapping = aes(Escannos, Disproporcionalidad)) +
  geom_point(aes(colour = factor(Metodo)))+
  labs(subtitle = "Variando la distribucion de los votos", title = "Disproporcionalidad", caption = "Angel Gonzalez", x = "Concentración (menor a mayor)")+guides(color=guide_legend(title="Método"))+
  theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6)
    )
```


En este gráfico nos centramos en los casos en que hay mayor concentración de votos de unos pocos partidos, lo que suele suceder actualmente.
Vemos que hay dos grupos diferenciados, uno en el que hay una alta disproporcionalidad, que serían los métodos Adams y Huntington-Hill y otro en el que la disproporcionalidad es baja.
En España actualmente la concentración de voto en alta o medio-alta y se utiliza el método de D´Hondt, por lo tanto observando el gráfico podemos decir que el método utilizado en España no es el más optimo en el caso de la concentración de voto actual en España, sería conveniente realizar un cambio de método y cambiarlo preferentemente por el método Sainte-Lague, que es el mejor entre los métodos del grupo con disproporcionalidad baja.




## Conclusiones 



En general podemos concluir que una vez comparados todos los métodos tanto modificando el número de escaños a repartir, en número de partidos que se presentan a la elección y la concentración de los votos, concluimos que el mejor método es el Saint-Lague, seguido por el Modified Sainte-Lague y el Danish.
En el caso del método utilizado actualmente en España, el método D´hondt, podemos decir que es un método que no siendo de los peores se queda en un medio que no es ni un método malo ni bueno, es decir, que no es un método que se debiese usar, puesto que no es el mejor en ninguno de las posibles modificaciones que se presentan en este estudio, siendo entonces conveniente para España cambiar el método de reparto de escaños y utilizar el método de Sainte-Lague que es el que consistentemente ha presentado los mejores resultados.


```{r message=FALSE, warning=FALSE}
knitr::write_bib(c("knitr","rmarkdown","dplyr","ggplot2","xtable",
"stringr","shiny","flexdashboard","htmlwidgets",
"bookdown","tidyselect","tibble","scales"),
file="bib/paquetemio.bib",
width = 60)
```

